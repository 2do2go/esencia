!function(e){"function"==typeof define&&define.amd?define(["underscore","backbone"],e):"object"==typeof exports?module.exports=e(require("underscore"),require("backbone")):this.Esencia=e(_,Backbone)}(function(e,t){function n(e){var t=n.cache[e];if(!t){var i={};t=n.cache[e]={id:e,exports:i},n.modules[e].call(i,t,i)}return t.exports}return n.cache=[],n.modules=[function(e,t){"use strict";var i=n(6),r=n(5),s={},o=["create","update","patch","delete","read"],a="PUT";s.sync=function(e,t,n){if(i.contains(o,e))return r.Collection.prototype.sync.call(this,e,t,n);n=n||{};var s={type:a,dataType:"json",contentType:"application/json",processData:!1};if(!n.url){var h=i.result(t,"url")||c();s.url=h+("/"===h.charAt(h.length-1)?"":"/")+e}n.data&&i.isObject(n.data)&&(n.data=JSON.stringify(n.data));var u=n.xhr=r.ajax(i.extend(s,n));return t.trigger("request",t,u,n),u},s.exec=function(e,t){t=t?i.clone(t):{};var n=this,r=t.success;t.success=function(i){r&&r(n,i,t),n.trigger("exec:"+e,n,i,t)};var s=t.error;return t.error=function(e){s&&s(n,e,t),n.trigger("error",n,e,t)},this.sync(e,this,t)};var c=function(){throw new Error('A "url" property or function must be specified')};e.exports=r.Collection.extend(s)},function(e,t){"use strict";var i=n(6),r=n(5),s=n(4),o=function(e){i.extend(this,i.pick(e,a)),this.options=e,this.components={},this.componentsTree=null,this.initialize.apply(this,arguments)},a=["rootComponentEl","viewOptions"],c=["name","parent","container","View","models","collections","viewOptions"];i.extend(o.prototype,r.Events,{rootComponentEl:"html",initialize:function(){},addRootComponent:function(){var e=s.extend({el:this.rootComponentEl});this.add({name:"",parent:null,View:e})},add:function(e){e=i({}).defaults(e,{parent:"",process:!1});var t=i(e).pick(c);if(i.isUndefined(t.name)&&(t.name=i.uniqueId("auto-named-component")),!i.isString(t.name))throw new Error("Component `name` option should be a string");if(t.name in this.components)throw new Error('Duplicate component with name "'+t.name+'"');if(!t.View)throw new Error("Component `View` option is required");if(!i.isString(t.parent)&&!i.isNull(t.parent))throw new Error("Component `parent` option should be a string or null");return this.components[t.name]=t,e.process&&this.process(t.name),t},get:function(e){return this.components[e]||null},remove:function(e){delete this.components[e]},process:function(e,t){t=t||i.noop;var n=this._calculateTree(e);this._applyTree({parentNode:null,oldNode:this.componentsTree,node:n},t)},_calculateTree:function(e,t){var n=this.components[e];if(!n)throw new Error('Unknown component with name "'+e+'"');var r={name:e};return t&&(r.child=t),i.isString(n.parent)?this._calculateTree(n.parent,r):r},_isTreeNodeChanged:function(e,t){if(!e||e.name!==t.name||!e.view)return!0;var n=this.components[t.name];return e.view instanceof n.View==!1||(!e.view.attached||!e.view.isUnchanged())},_applyTree:function(e,t){var n=this,r=e.parentNode,s=function(e,i){var s=i.child;delete i.child,r?r.child=i:n.componentsTree=i,s?n._applyTree({parentNode:i,oldNode:e&&e.child||null,node:s},t):t()},o=e.node,a=e.oldNode,c=this.components[o.name],h=function(e){if(o.view=e,e.setData(),c.container){if(!r)throw new Error("Parent component should exist for component with `container` option");r.view.setView(e,c.container).renderViews().attachViews()}else e.render();s(null,o)},u=a&&a.view;if(this._isTreeNodeChanged(a,o)){u&&(u.container?c.container&&u.container===c.container||u.remove():u.detach());var l=new c.View(i(c).chain().pick("models","collections").extendOwn(i(c).result("viewOptions"),this.viewOptions).value());l.waiting?l.once("resolve",function(){h(l)}):h(l)}else{var d,p=a.child&&a.child.view;p&&(d=p.container,d&&u.removeView(p,d)),o.view=u,u.setData(),u.render(),p&&d&&u.setView(p,d),s(a,o)}}}),o.extend=s.extend,e.exports=o},function(e,t){"use strict";var i=n(3),r=n(0),s=n(4),o=n(1);e.exports.Router=i,e.exports.Collection=r,e.exports.View=s,e.exports.ComponentsManager=o},function(e,t){"use strict";var i=n(6),r=n(5),s=n(1),o={root:"/",pushState:!1,namedParameters:!1,nowhereUrl:"___",config:{},autoloadModules:!0,modulesPath:"modules/",defaultModuleName:"main",onModuleError:function(){}},a=["root","pushState","namedParameters","nowhereUrl","config","autoloadModules","modulesPath","defaultModuleName","onModuleError"];o.constructor=function(e){e=e||{},i.extend(this,i.pick(e,a)),this.options=e,this.componentsManager=new s(i.extend({},e,{viewOptions:{router:this}})),this.urlParams={},this.modules={},this.history=r.history,r.Router.namedParameters=this.namedParameters,r.Router.apply(this,arguments),e.autoloadModules&&this.route("*url",function(e){this.setModule(e)})},o._populateUrlParams=function(){var e,t=this;for(e in this.urlParams)i(this.urlParams).has(e)&&delete this.urlParams[e];return i(arguments).chain().filter(i.isObject).each(function(e){e=i.isFunction(e)?e.call(t):e,i.extendOwn(t.urlParams,e)}),this.urlParams},o.component=function(e){var t=this,n=this.componentsManager.add(e);i.isUndefined(e.url)||this.route(e.url,n.name,function(i){t._populateUrlParams(e.defaultUrlParams,i),t.componentsManager.process(n.name)})},o.route=function(e,t,n){var s=this;i.isFunction(t)&&(n=t,t=""),r.Router.prototype.route.call(this,e,t,function(){var i=arguments;s._defaultMiddleware({url:e,name:t,callback:n},function(){n.apply(s,i)})})},o.navigate=function(e,t){if(t=t||{},0===e.indexOf(this.root)&&(e=e.substring(this.root.length)),t.force)return this.navigate(this.nowhereUrl,{replace:t.replace,trigger:!1}),t=i(t).chain().omit("force").extend({replace:!0}).value(),this.navigate(e,t);t=i(t||{}).defaults({trigger:!0,params:{}});var n=t.qs;this.toFragment&&n&&(i(n).each(function(e,t,n){void 0!==e&&null!==e||delete n[t]}),e=this.toFragment(e,n),delete t.qs),r.Router.prototype.navigate.call(this,e,t)},o._defaultMiddleware=function(e,t){t()},o.middleware=function(e){var t=this,n=this._defaultMiddleware;return this._defaultMiddleware=function(i,r){n.call(t,i,function(){e.call(t,i,r)})},this},o.setModule=function(e){var t=this,n=e.url;delete e.url;var r=i(n.split("/")).find(i.identity)||this.defaultModuleName;require([this.modulesPath+r],function(i){t.modules[r]||(i(t),t.modules[r]=!0,t.navigate(n,{replace:!0,force:!0,qs:e}))},this.onModuleError)},o.start=function(){this.componentsManager.addRootComponent(),r.history.start({pushState:this.pushState,root:this.root})},e.exports=r.Router.extend(o)},function(e,t){"use strict";var i=n(6),r=n(5),s=r.$,o=Array.prototype.splice,a=/^(\S+)\s*(.*)$/,c=["views","collections","models"],h={templateHelpers:{}},u=["models","collections","views","events","data","router","templateHelpers"];h.constructor=function(e){var t=this;if(e=e||{},this.views={},this.data=this.data||{},i.extend(this,i.pick(e,u)),this.options=e,this.template&&!i.isFunction(this.template))throw new Error("View `template` option should be a function");this._normalizeViews(),this._prepareNestedEvents(),this.waiting=!1,this.attached=!1,r.View.apply(this,arguments),this.collections&&i(this.collections).each(function(e,n){t.delegateNestedEvents("collections",n,e)}),this.models&&i(this.models).each(function(e,n){t.delegateNestedEvents("models",n,e)})},h.setData=function(e){e&&(this.data=e)},h.isUnchanged=function(){return!0},h.wait=function(){var e=this;return this.waiting=!0,function(){e.waiting=!1,e.trigger("resolve")}},h.render=function(e){if(this.waiting)return this;if(e=e||{},this.template){if(e.force||!this.attached||!this.isUnchanged()){this.detach();var t=this.renderTemplate(this.template,this.getTemplateData()),n=s(t);if(!n.length)throw new Error("View template produce empty html");if(n.length>1)throw new Error("View template produce html with more than one root elements");this.setElement(n)}}else this.$el.length||this._ensureElement();return this.renderViews(e),this.parent&&!this.$container||(this.attachViews(),this.attach()),this},h.getTemplateData=function(){return this.data},h.renderTemplate=function(e,t){return t=i(this).chain().result("templateHelpers").extend(t).value(),e(t)},h.renderViews=function(e){var t=this;return i(this.views).each(function(n,r){if(n.length){i(n).each(function(t){t.render(e)});var s=r?t.$(r).first():t.$el;if(!s.length)throw new Error('Container "'+r+'" is not found');var o=s.get(0),a=i(n).some(function(e){return!e.attached||!e.$container||e.$container.get(0)!==o});if(a){var c=[];i(n).each(function(e){e.$container=s,c.push(e.$el)}),s.append(c)}}}),this},h.setView=function(e,t,n){return this._updateViews([e],t,n)},h.setViews=function(e,t,n){return this._updateViews(e,t,n)},h.replaceView=function(e,t,n){return this._updateViews([e],t,n)},h.replaceViews=function(e,t,n){return this._updateViews(e,t,n)},h.appendView=function(e,t){return this._insertViews([e],t)},h.appendViews=function(e,t){return this._insertViews(e,t)},h.prependView=function(e,t){return this._insertViews([e],t,0)},h.prependViews=function(e,t){return this._insertViews(e,t,0)},h.insertView=function(e,t,n){return this._insertViews([e],t,n)},h.insertViews=function(e,t,n){return this._insertViews(e,t,n)},h.removeView=function(e,t,n){if(arguments.length<2)throw new Error('"view" or "index" arguments must be specified');return i.isString(e)&&(n=t,t=e,e=this.getView(t,n),!e)?this:this._removeViews([e],t)},h.removeViews=function(e,t){return i.isString(e)&&(t=e,e=this.getViews(t)),this._removeViews(e,t)},h.getView=function(e,t){return this.getViews(e)[t||0]||null},h.getViews=function(e){return i.clone(this.views[e])||[]},h._insertViews=function(e,t,n){var r=this,s=this.getViews(t);return i(e).each(function(e){e.parent&&e.parent.removeView(e,e.container)}),s.length?("undefined"==typeof n&&(n=s.length),o.apply(this.views[t],[n,0].concat(e))):this.views[t]=e,i(e).each(function(e){e.parent=r,e.container=t}),this.delegateNestedEvents("views",t,e),this},h._updateViews=function(e,t,n){var r=this.getViews(t);if(r.length){var s=[];"undefined"!=typeof n?(s=this.getView(t,n),s=s?[s]:[]):s=r,s.length&&(this._removeViews(s,t),i(s).each(function(e){e.remove()}))}return this._insertViews(e,t,n)},h._removeViews=function(e,t){var n=this,r=this.getViews(t);if(!r.length)return this;var s=i.chain(e).uniq().map(function(e){return{view:e,index:i.indexOf(r,e)}}).filter(function(e){return e.index>=0}).sortBy(function(e){return-e.index}).value();return s.length?(i(s).each(function(e){var i=e.view;o.call(n.views[t],e.index,1),n.undelegateNestedEvents(i),delete i.parent}),this):this},h.setElement=function(e){var t=this.$el;return this._setElement(e),t&&this.$container&&t.replaceWith(this.$el),this},h.delegateEvents=function(e){return(e=e||i.result(this,"events"))?(e=i(e).omit(c),r.View.prototype.delegateEvents.call(this,e)):this},h.delegateNestedEvents=function(e,t,n){var r=this;i.isArray(n)||(n=[n]);var s=this._nestedEventsHash[e][t];return s&&i(s).each(function(e){i(n).each(function(t){r.listenTo(t,e.eventName,e.handler)})}),this},h.undelegateNestedEvents=function(e){var t=this;return i.isArray(e)||(e=[e]),i(e).each(function(e){t.stopListening(e)}),this},h._prepareNestedEvents=function(e){var t=this;this._nestedEventsHash={},i(c).each(function(e){t._nestedEventsHash[e]={}}),e=e||i.result(this,"events"),e&&i(c).each(function(n){var r=t._nestedEventsHash[n];i(e).has(n)&&i.isObject(e[n])&&i(e[n]).each(function(e,n){if(i.isFunction(e)||(e=t[e]),e){var s=n.match(a),o=s[1],c=s[2].replace(/ *, */g,",").split(",");e=i.bind(e,t),i(c).each(function(t){r[t]=r[t]||[],r[t].push({eventName:o,handler:e})})}})})},h._normalizeViews=function(){var e=this;i(this.views).each(function(t,n){i.isArray(t)||(e.views[n]=[t])})},h.attachViews=function(){return i(this.views).each(function(e){e.length&&i(e).each(function(e){e.attachViews(),e.attach()})}),this},h.afterAttach=function(){return this},h.attach=function(){if(this.attached)return this;var e=this.$el.data("esencia-view");return e&&e.detach(),this.$el.data("esencia-view",this).attr("esencia-view",this.cid),this.delegateEvents(),this.attached=!0,this.afterAttach(),this},h.detachViews=function(){return i(this.views).each(function(e){e.length&&i(e).each(function(e){e.detachViews(),e.detach()})}),this},h.beforeDetach=function(){return this},h.detach=function(){return this.attached?(this.beforeDetach(),this.$el.removeData("esencia-view").removeAttr("esencia-view"),this.undelegateEvents(),this.attached=!1,this):this},h.remove=function(){return this.parent&&this.parent.removeView(this,this.container),this.detachViews(),this.detach(),r.View.prototype.remove.call(this)},h.getClosestView=function(e){var t=s(e);return t.is("[esencia-view]")||(t=t.closest("[esencia-view]")),t.length?t.data("esencia-view"):null},e.exports=r.View.extend(h)},function(e,n){e.exports=t},function(t,n){t.exports=e}],n(2)});
//# sourceMappingURL=esencia.min.js.map
