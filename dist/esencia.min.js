!function(e){"function"==typeof define&&define.amd?define(["underscore","backbone"],e):"object"==typeof exports?module.exports=e(require("underscore"),require("backbone")):this.Esencia=e(_,Backbone)}(function(e,t){function n(e){var t=n.cache[e];if(!t){var i={};t=n.cache[e]={id:e,exports:i},n.modules[e].call(i,t,i)}return t.exports}return n.cache=[],n.modules=[function(e,t){"use strict";var i=n(10),r=n(9),o=n(7),s={};s.sync=function(e,t,n){return n=o.prepareOptions(e,t,n),e=o.getFakeBaseMethod(n),r.Collection.prototype.sync.call(this,e,t,n)},s.exec=function(e,t){t=i.extend({parse:!0},t);var n=this,r=t.success;return t.success=function(i){t.fetch&&n[t.reset?"reset":"set"](i,t),r&&r.call(t.context,n,i,t),n.trigger("exec:"+e,n,i,t)},o.wrapError(this,t),this.sync(e,this,t)},e.exports=r.Collection.extend(s)},function(e,t){"use strict";function i(e,t){return Boolean(!e||e.component.name!==t.component.name||!e.view||e.view instanceof t.component.View==!1||e.view.isWaiting()||!e.view.attached||!e.view.isUnchanged())}var r=n(10),o=n(9),s=n(4),a=n(8),c=function(e){e=e||{},r.extend(this,r.pick(e,u)),this.options=e,this.components={},this.tree=[],this.currentNames=[],this.autoAddRoot&&this._addRoot(),this.initialize.apply(this,arguments)},u=["rootEl","autoAddRoot"],h=["name","parent","container","View","model","models","collection","collections","viewOptions"];r.extend(c.prototype,o.Events,{rootEl:"html",autoAddRoot:!0,defaultParent:void 0,initialize:function(){},_addRoot:function(){var e=s.extend({el:this.rootEl});this.add({parent:null,View:e})},add:function(e){e=r.defaults({},e,{parent:this.defaultParent,load:!1});var t=r.pick(e,h),n=r.has(t,"name"),i=r.has(t,"container"),o=r.isString(t.parent),s=r.isNull(t.parent),a=r.isString(this.defaultParent);if(n&&!r.isString(t.name))throw new Error("Component `name` option should be a string");if(n&&r.has(this.components,t.name))throw new Error('Duplicate component with name "'+t.name+'"');if(!r.has(t,"View"))throw new Error("Component `View` option is required");if(!a&&r.isUndefined(t.parent))throw new Error("Default root component is not set, add root component first");if(!o&&!s)throw new Error("Component `parent` option should be a string or null");if(s&&i)throw new Error("Root component could not have a container");if(o&&!i)throw new Error("Component `container` option is required for components with parent");if(i&&!r.isString(t.container))throw new Error("Component `container` option should be a string selector");return n||(t.name=r.uniqueId("__COMPONENT_")+"__"),this.components[t.name]=t,!s||a&&!e["default"]||(this.defaultParent=t.name),e.load&&this.load(t.name),t},get:function(e){var t=this.components[e];if(!t)throw new Error('Component with name "'+e+'" does not exist');return t},remove:function(e){delete this.components[e]},load:function(e,t,n){if(r.isFunction(e)&&(n=e,e=void 0,t=void 0),r.isFunction(t)&&(n=t,t=void 0),e=e||this.currentNames,t=t||{},n=n||r.noop,r.isArray(e)||(e=[e]),!e.length)throw new Error("Component name or names to load should be set");var i=this._buildTree(e),o=this.tree;this.tree=[],this.currentNames=e,this._applyTree({parent:{children:this.tree},oldTree:o,tree:i},n)},_buildTree:function(e){var t=this,n=function(e,i){if(!e.length)return i;var o=[],s=r(e).chain().uniq().map(function(e){var n=t.get(e);if(r.has(i,n.name))return null;var s={component:n,children:[]};return r.isString(n.parent)&&o.push(n.parent),i[n.name]=s,s}).compact().value();return i=n(o,i),r(s).each(function(e){if(r.isString(e.component.parent)){if(e.component.container&&r(i[e.component.parent].children).find(function(t){return t.component.container===e.component.container}))throw new Error("Components could not have same container and parent in one tree");i[e.component.parent].children.push(e)}}),i},i=n(e,{});if(r.isEmpty(i))throw new Error("Components tree is empty");if(i=r(i).filter(function(e){return r.isNull(e.component.parent)}),!i.length)throw new Error("Components tree should have at least one root node");if(r(i).some(function(e){return e.component.container}))throw new Error("Root component could not have a container");return i},_applyTree:function(e,t){var n=this,o=e.parent,s=r.after(e.tree.length,t),a=function(e,t){var i=t.component.container,a=t.children,c=e?e.children:[];if(t.view.setData(),!t.view.attached&&i)o.view.setView(t.view,i).renderViews({include:[i]}).attachViews({include:[i]});else{var u=r.union(r(a).chain().map(function(e){return e.component.container}).compact().value(),r(c).chain().map(function(e){return e.component.container}).compact().value());t.view.render({exclude:u})}t.children=[],o.children.push(t),n._applyTree({parent:t,oldTree:c,tree:a},s)};r(e.tree).each(function(t,o){var s=e.oldTree[o]||null;i(s,t)?(s&&s.view&&(s.component.container?s.component.container!==t.component.container&&s.view.remove():s.view.detach()),t.view=new t.component.View(r(t.component).chain().pick("model","models","collection","collections").extend(r.result(t.component,"viewOptions"),{componentsManager:this}).value()),t.view.isWaiting()?n.listenToOnce(t.view,"esencia:resolve",function(){a(null,t)}):a(null,t)):(t.view=s.view,a(s,t))})}}),c.extend=a,e.exports=c},function(e,t){"use strict";var i=n(10),r=n(9),o=n(7),s={};s.sync=function(e,t,n){return n=o.prepareOptions(e,t,n),e=o.getFakeBaseMethod(n),r.Model.prototype.sync.call(this,e,t,n)},s.exec=function(e,t){t=i.extend({parse:!0},t);var n=this,r=t.success;return t.success=function(i){if(t.fetch){var o=t.parse?n.parse(i,t):i;if(!n.set(o,t))return!1}r&&r.call(t.context,n,i,t),n.trigger("exec:"+e,n,i,t)},o.wrapError(this,t),this.sync(e,this,t)},e.exports=r.Model.extend(s)},function(e,t){"use strict";var i=n(10),r=n(9),o=n(6),s={componentsManager:o,namedParameters:!0,autoloadModules:!0,modulesPath:"modules/",defaultModuleName:"main",onModuleError:function(){}},a=["componentsManager","namedParameters","autoloadModules","modulesPath","defaultModuleName","onModuleError"];s.constructor=function(e){e=e||{},i.extend(this,i.pick(e,a)),this.options=e,this.modules={},r.Router.apply(this,arguments)},s.component=function(e){return this.componentsManager.add(e)},s.route=function(e,t,n){var o=this;i.isFunction(t)&&(n=t,t={}),i.isObject(t)||(t={name:t});var s="";if(i.has(t,"components")||i.has(t,"component")){var a=i(t.components||[t.component]).map(function(e){return i.isString(e)?o.componentsManager.get(e):o.component(e)}),c=i.pluck(a,"name");s=c.join(","),n=function(){o.componentsManager.load(c)}}s=t.name||s,r.Router.prototype.route.call(this,e,s,n)};var c=/(\(\?)?:\w+/g,u=/\*\w+/g,h=/[\:\*]([^\:\?\/]+)/g;s._routeToRegExp=function(e){var t=u.exec(e)||{index:-1},n=c.exec(e)||{index:-1},o=e.match(h)||[];return e=r.Router.prototype._routeToRegExp.call(this,e),t.index>=0&&(n>=0?e.splatMatch=t.index-n.index:e.splatMatch=-1),e.paramNames=i(o).map(function(e){return e.replace(/\)$/,"").substring(1)}),e},s._extractParameters=function(e,t){var n=r.Router.prototype._extractParameters.call(this,e,t),o={},s=n.length;if(e.splatMatch){if(e.splatMatch<0)return n;s-=1}console.log(">>>>>>>>",s,e.paramNames);for(var a=0;a<s;a++)i.isString(n[a])&&e.paramNames&&e.paramNames.length>=a-1&&(o[e.paramNames[a]]=n[a]);return console.log(">>>>>>>>",o),this.namedParameters?[o]:n},s.loadModule=function(e){var t=this;e=e||r.history.fragment;var n=this.getModuleName(e);require([this.modulesPath+n],function(i){t.modules[n]||(i(t),t.modules[n]=!0,r.history.loadUrl(e))},this.onModuleError)},s.getModuleName=function(e){return i(e.split("/")).find(i.identity)||this.defaultModuleName},e.exports=r.Router.extend(s)},function(e,t){"use strict";function i(e,t){var n=t.exclude,i=t.include;return Boolean(n&&r.contains(r.isArray(n)?n:[n],e)||i&&!r.contains(r.isArray(i)?i:[i],e))}var r=n(10),o=n(9),s=o.$,a=Array.prototype.splice,c=/^(\S+)\s*(.*)$/,u={templateHelpers:{},waitsCounter:0,waitAvailable:!0,attached:!1},h=["views","models","collections"],l=["viewEvents","modelEvents","collectionEvents"],d=r.union(h,l,["ui","triggers"]),p=r.union(d,["model","collection","data","componentsManager","template","templateHelpers"]);u.constructor=function(e){var t=this;e=e||{},this.data={},r.extend(this,r.pick(e,p)),this.options=e,r(d).each(function(e){t[e]=r.result(t,e,{})}),this._prepareNestedEvents(),this._prepareModels(),this._prepareCollections(),this._prepareViews(),r(this.views).each(function(e,n){t.delegateNestedEvents("views",n,e)}),o.View.call(this,r.omit(e,"model","collection")),r(this.views).each(function(e){r(e).each(function(e){e.isWaiting()&&t.listenToOnce(e,"esencia:resolve",t.wait())})}),this.waitAvailable=!1,r(this.collections).each(function(e,n){t.delegateNestedEvents("collections",n,e)}),r(this.models).each(function(e,n){t.delegateNestedEvents("models",n,e)})},u.setData=function(e){return e&&(this.data=e),this},u.isUnchanged=function(){return!0},u.wait=function(){if(!this.waitAvailable)throw new Error("Method .wait() is available only in the constructor");var e=this;return this.waitsCounter++,this.trigger("esencia:wait"),r.once(function(){r.defer(function(){e.waitsCounter--,e.isWaiting()||e.trigger("esencia:resolve")})})},u.isWaiting=function(){return this.waitsCounter>0},u._render=function(e){if(this.isWaiting())return this;if(e=e||{},this.template){if(e.force||!this.attached||!this.isUnchanged()){this.detach();var t=r(this).chain().result("templateHelpers").extend(this.getTemplateData()).value(),n=this.renderTemplate(this.template,t);if(!r.isString(n))throw new Error("`renderTemplate` method should return a HTML string");var i=s(n);if(!i.length)throw new Error("View template produces empty html");if(i.length>1)throw new Error("View template produces html with more than one root elements");this.setElement(i)}}else this.$el.length||this._ensureElement();return this.trigger("esencia:render"),this.renderViews(e),this.parent&&!this.$container||(this.attachViews(e),this.attach()),this},u.render=function(e){return this._render(e)},u.getTemplateData=function(){return this.data},u.renderTemplate=function(e,t){if(!r.isFunction(e))throw new Error("View `template` should be a function");return e(t)},u.renderViews=function(e){var t=this;return r(this.views).each(function(n,o){if(!i(o,e)&&n.length){r(n).each(function(t){t.render(r.omit(e,"include","exclude"))});var s=o?t.$(o).first():t.$el;if(!s.length)throw new Error('Container "'+o+'" is not found');var a=s.get(0),c=r(n).some(function(e){return!e.attached||!e.$container||e.$container.get(0)!==a});if(c){var u=[];r(n).each(function(e){e.$container=s,u.push(e.$el)}),s.append(u)}}}),this},u.setView=function(e,t,n){return this._updateViews([e],t,n)},u.setViews=function(e,t,n){return this._updateViews(e,t,n)},u.appendView=function(e,t){return this._insertViews([e],t)},u.appendViews=function(e,t){return this._insertViews(e,t)},u.prependView=function(e,t){return this._insertViews([e],t,0)},u.prependViews=function(e,t){return this._insertViews(e,t,0)},u.insertView=function(e,t,n){return this._insertViews([e],t,n)},u.insertViews=function(e,t,n){return this._insertViews(e,t,n)},u.removeView=function(e,t,n){if(arguments.length<2)throw new Error('"view" or "index" arguments must be specified');return r.isString(e)&&(n=t,t=e,e=this.getView(t,n),!e)?this:this._removeViews([e],t)},u.removeViews=function(e,t){return r.isString(e)&&(t=e,e=this.getViews(t)),this._removeViews(e,t)},u.getView=function(e,t){return this.getViews(e)[t||0]||null},u.getViews=function(e){return r.clone(this.views[e])||[]},u._insertViews=function(e,t,n){var i=this,o=this.getViews(t);return r(e).each(function(e){e.parent&&e.parent.removeView(e,e.container)}),o.length?("undefined"==typeof n&&(n=o.length),a.apply(this.views[t],[n,0].concat(e))):this.views[t]=e,r(e).each(function(e){e.parent=i,e.container=t}),this.delegateNestedEvents("views",t,e),this},u._updateViews=function(e,t,n){var i;return"undefined"==typeof n?i=this.getViews(t):(i=this.getView(t,n),i=i?[i]:[]),i.length===e.length&&r(i).all(function(t,n){return t===e[n]})?this:(i.length&&(this._removeViews(i,t),r(i).each(function(e){e.remove()})),this._insertViews(e,t,n))},u._removeViews=function(e,t){var n=this,i=this.getViews(t);if(!i.length)return this;var o=r(e).chain().uniq().map(function(e){return{view:e,index:r.indexOf(i,e)}}).filter(function(e){return e.index>=0}).sortBy(function(e){return-e.index}).value();return o.length?(r(o).each(function(e){var i=e.view;a.call(n.views[t],e.index,1),n.undelegateNestedEvents(i),delete i.parent}),this):this},u.setElement=function(e){var t=this.$el;return this._setElement(e),t&&this.$container&&t.replaceWith(this.$el),this.ensureUI(),this},u.ensureUI=function(){var e=this;return this.$ui=r(this.ui).mapObject(function(t){return e.$(t)}),this},u.delegateTriggers=function(e){if(e=e||r.result(this,"triggers"),!e)return this;var t=this;return this.undelegateTriggers(),r(e).each(function(e,n){var i=function(){t.trigger.apply(t,[e].concat(r.toArray(arguments)))},o=n.match(c);t.delegateTrigger(o[1],o[2],i)}),this},u.delegateTrigger=function(e,t,n){return this.$el.on(e+".delegateTriggers"+this.cid,t,n),this},u.undelegateTriggers=function(){return this.$el&&this.$el.off(".delegateTriggers"+this.cid),this},u.undelegateTrigger=function(e,t,n){return this.$el.off(e+".delegateTriggers"+this.cid,t,n),this},u.delegateNestedEvents=function(e,t,n){if(!r.contains(h,e))throw new Error('Wrong entity type "'+e+'", available values: '+h.join(", "));var i=this;if(n||(n=this[e][t]),!n)return this;r.isArray(n)||(n=[n]);var o=this._nestedEvents[e][t];return o&&(this.undelegateNestedEvents(n),r(o).each(function(e){r(n).each(function(t){i.listenTo(t,e.eventName,e.handler)})})),this},u.undelegateNestedEvents=function(e){var t=this;return r.isArray(e)||(e=[e]),r(e).each(function(e){t.stopListening(e)}),this},u._prepareNestedEvents=function(){var e=this;this._nestedEvents={},r(h).each(function(t){e._nestedEvents[t]={}}),r(l).each(function(t,n){var i=h[n],o=e._nestedEvents[i];r(e[t]).each(function(t,n){if(r.isFunction(t)||(t=e[t]),t){var i=n.match(c),s=i[1],a=i[2].replace(/ *, */g,",").split(",");t=r.bind(t,e),r(a).each(function(e){o[e]=o[e]||[],o[e].push({eventName:s,handler:t})})}})})},u._prepareViews=function(){var e=this;r(this.views).each(function(t,n){r.isArray(t)||(t=[t]),e.views[n]=t=r(t).map(function(e){return r.isFunction(e)&&(e=new e),e})})},u._prepareModels=function(){var e=this;r(this.models).each(function(t,n){r.isFunction(t)&&(e.models[n]=new t)}),this.model&&(r.isFunction(this.model)&&(this.model=new this.model),this.models[""]=this.model)},u._prepareCollections=function(){var e=this;r(this.collections).each(function(t,n){r.isFunction(t)&&(e.collections[n]=new t)}),this.collection&&(r.isFunction(this.collection)&&(this.collection=new this.collection),this.collections[""]=this.collection)},u.attachViews=function(e){return e=e||{},r(this.views).each(function(t,n){i(n,e)||t.length&&r(t).each(function(t){t.attachViews(r.omit(e,"include","exclude")),t.attach()})}),this},u.afterAttach=function(){return this},u.attach=function(){if(this.attached)return this;var e=this.$el.data("esencia-view");return e&&e.detach(),this.$el.data("esencia-view",this).attr("esencia-view",this.cid),this.delegateEvents(),this.delegateTriggers(),this.attached=!0,this.afterAttach(),this.trigger("esencia:attach"),this},u.detachViews=function(){return r(this.views).each(function(e){e.length&&r(e).each(function(e){e.detachViews(),e.detach()})}),this},u.beforeDetach=function(){return this},u.detach=function(){return this.attached?(this.trigger("esencia:detach"),this.beforeDetach(),this.$el.removeData("esencia-view").removeAttr("esencia-view"),this.undelegateEvents(),this.undelegateTriggers(),this.attached=!1,this):this},u.remove=function(){return this.parent&&this.parent.removeView(this,this.container),this.detachViews(),this.detach(),o.View.prototype.remove.call(this)},u.getClosestView=function(e){var t=s(e);return t.is("[esencia-view]")||(t=t.closest("[esencia-view]")),t.length?t.data("esencia-view"):null},e.exports=o.View.extend(u)},function(e,t){"use strict";var i=n(9),r=n(10),o=n(3),s=n(0),a=n(2),c=n(4),u=n(1),h=n(6),l=n(8),d=t;r.extend(d,i.Events);var p=["Events","History","history"];r.extend(d,r.pick(i,p)),r.extend(d,{Router:o,Collection:s,Model:a,View:c,ComponentsManager:u}),d.componentsManager=h,d.extend=l},function(e,t){"use strict";var i=n(1);e.exports=new i},function(e,t){"use strict";var i=n(10),r="PUT",o=function(){throw new Error("A `url` property or function must be specified")};t.wrapError=function(e,t){var n=t.error;t.error=function(i){n&&n.call(t.context,e,i,t),e.trigger("error",e,i,t)}},t.prepareOptions=function(e,t,n){if(n=i.extend({type:r,dataType:"json",contentType:"application/json",processData:!1},n),!n.url){var s=i.result(t,"url")||o();n.url=s.replace(/[^\/]$/,"$&/")+e}return n.data&&i.isObject(n.data)&&!n.processData&&(n.data=JSON.stringify(n.data)),n};var s={POST:"create",PUT:"update",PATCH:"patch",DELETE:"delete",GET:"read"};t.getFakeBaseMethod=function(e){return s[e.type.toUpperCase()]}},function(e,t){"use strict";var i=n(9);e.exports=i.View.extend},function(e,n){e.exports=t},function(t,n){t.exports=e}],n(5)});
//# sourceMappingURL=esencia.min.js.map
