!function(e){"function"==typeof define&&define.amd?define(["underscore","backbone"],e):"object"==typeof exports?module.exports=e(require("underscore"),require("backbone")):this.Esencia=e(_,Backbone)}(function(e,t){function n(e){var t=n.cache[e];if(!t){var i={};t=n.cache[e]={id:e,exports:i},n.modules[e].call(i,t,i)}return t.exports}return n.cache=[],n.modules=[function(e,t){"use strict";var i=n(11),r=n(10),o=n(8),s={};s.sync=function(e,t,n){return i.contains(o.baseMethods,e)||(n=o.prepareOptions(e,t,n),e=o.getFakeBaseMethod(n)),r.Collection.prototype.sync.call(this,e,t,n)},s.exec=function(e,t){t=i.extend({parse:!0},t);var n=this,r=t.success;return t.success=function(i){t.fetch&&n[t.reset?"reset":"set"](i,t),r&&r.call(t.context,n,i,t),n.trigger("exec:"+e,n,i,t)},o.wrapError(this,t),this.sync(e,this,t)},e.exports=r.Collection.extend(s)},function(e,t){"use strict";var i=n(5),r=n(11),o={},s={add:"_onCollectionAdd",change:"_onCollectionChange",remove:"_onCollectionRemove"};o._prepareViews=function(){i.prototype._prepareViews.call(this);var e=this;this.views[this.itemsContainer]=this.collection.map(function(t){return new e.ItemView({model:t})})},o._prepareEntityEvents=function(){i.prototype._prepareEntityEvents.call(this),this._addEntityEvents("collections",s)},o._onCollectionAdd=function(e){var t=r.indexOf(this.collection.models,e);this.addView(new this.ItemView({model:e}),this.itemsContainer,{at:t}),this.render({include:this.itemsContainer})},o._onCollectionChange=function(e){var t=r.indexOf(this.collection.models,e),n=this.getView(this.itemsContainer,t);n.render()},o._onCollectionRemove=function(e,t,n){var i=this.getView(this.itemsContainer,n.index);i.remove()},e.exports=i.extend(o)},function(e,t){"use strict";function i(e,t){return Boolean(!e||e.component.name!==t.component.name||!e.view||e.view instanceof t.component.View==!1||e.view.isWaiting()||!e.view.attached||e.view.applyState())}var r=n(11),o=n(10),s=n(5),a=n(9),c=function(e){e=e||{},r.extend(this,r.pick(e,h)),this.options=e,this.components={},this.tree=[],this.currentNames=[],this.autoAddRoot&&this._addRoot(),this.initialize.apply(this,arguments)},h=["rootEl","autoAddRoot"],u=["name","parent","container","View","model","models","collection","collections","viewOptions"];r.extend(c.prototype,o.Events,{rootEl:"html",autoAddRoot:!0,defaultParent:void 0,initialize:function(){},_addRoot:function(){var e=s.extend({el:this.rootEl});this.add({parent:null,View:e})},add:function(e){e=r.defaults({},e,{parent:this.defaultParent,load:!1});var t=r.pick(e,u),n=r.has(t,"name"),i=r.has(t,"container"),o=r.isString(t.parent),s=r.isNull(t.parent),a=r.isString(this.defaultParent);if(n&&!r.isString(t.name))throw new Error("Component `name` option should be a string");if(n&&r.has(this.components,t.name))throw new Error('Duplicate component with name "'+t.name+'"');if(!r.has(t,"View"))throw new Error("Component `View` option is required");if(!a&&r.isUndefined(t.parent))throw new Error("Default root component is not set, add root component first");if(!o&&!s)throw new Error("Component `parent` option should be a string or null");if(s&&i)throw new Error("Root component could not have a container");if(o&&!i)throw new Error("Component `container` option is required for components with parent");if(i&&!r.isString(t.container))throw new Error("Component `container` option should be a string selector");return n||(t.name=r.uniqueId("__COMPONENT_")+"__"),this.components[t.name]=t,!s||a&&!e["default"]||(this.defaultParent=t.name),e.load&&this.load(t.name),t},get:function(e){var t=this.components[e];if(!t)throw new Error('Component with name "'+e+'" does not exist');return t},remove:function(e){delete this.components[e]},load:function(e,t,n){if(r.isFunction(e)&&(n=e,e=void 0,t=void 0),r.isFunction(t)&&(n=t,r.isArray(e)||r.isString(e)?t=void 0:(t=e,e=void 0)),e=e||this.currentNames,t=t||{},n=n||r.noop,r.isArray(e)||(e=[e]),!e.length)throw new Error("Component name or names to load should be set");var i=this._buildTree(e),o=this.tree;this.tree=[],this.currentNames=e,this._applyTree({parent:{children:this.tree},oldNodes:o,nodes:i},t,n)},_buildTree:function(e){var t=this,n=function(e,i){if(!e.length)return i;var o=[],s=r(e).chain().uniq().map(function(e){var n=t.get(e);if(r.has(i,n.name))return null;var s={component:n,children:[]};return r.isString(n.parent)&&o.push(n.parent),i[n.name]=s,s}).compact().value();return i=n(o,i),r(s).each(function(e){if(r.isString(e.component.parent)){if(e.component.container&&r(i[e.component.parent].children).find(function(t){return t.component.container===e.component.container}))throw new Error("Components could not have same container and parent in one tree");i[e.component.parent].children.push(e)}}),i},i=n(e,{});if(r.isEmpty(i))throw new Error("Components tree is empty");if(i=r(i).filter(function(e){return r.isNull(e.component.parent)}),!i.length)throw new Error("Components tree should have at least one root node");if(r(i).some(function(e){return e.component.container}))throw new Error("Root component could not have a container");return i},_applyTree:function(e,t,n){var o=this,s=e.parent,a=r.after(e.nodes.length,n),c=function(e,n){var i=n.component.container,c=n.children,h=e?e.children:[];n.view.update(t.viewOptions);var u=r.union(r(c).chain().map(function(e){return e.component.container}).compact().value(),r(h).chain().map(function(e){return e.component.container}).compact().value());!n.view.attached&&i?s.view.setView(n.view,i).renderViews({include:[i]}).attachViews({include:[i]}):n.view.render({exclude:u}),n.view.isWaiting()&&o.listenToOnce(n.view,"resolved",function(){n.view.render({exclude:u})}),n.children=[],s.children.push(n),o._applyTree({parent:n,oldNodes:h,nodes:c},t,a)};r(e.nodes).each(function(n,s){var a=e.oldNodes[s]||null;i(a,n)?(a&&a.view&&(a.component.container?a.component.container!==n.component.container&&a.view.remove():a.view.detach()),n.view=new n.component.View(r(n.component).chain().pick("model","models","collection","collections").extend(r.result(n.component,"viewOptions"),{componentsManager:o},t.viewOptions).value()),n.view.isWaiting()?o.listenToOnce(n.view,"resolved",function(){c(null,n)}):c(null,n)):(n.view=a.view,c(a,n))})}}),c.extend=a,e.exports=c},function(e,t){"use strict";var i=n(11),r=n(10),o=n(8),s={};s.sync=function(e,t,n){return i.contains(o.baseMethods,e)||(n=o.prepareOptions(e,t,n),e=o.getFakeBaseMethod(n)),r.Model.prototype.sync.call(this,e,t,n)},s.exec=function(e,t){t=i.extend({parse:!0},t);var n=this,r=t.success;return t.success=function(i){if(t.fetch){var o=t.parse?n.parse(i,t):i;if(!n.set(o,t))return!1}r&&r.call(t.context,n,i,t),n.trigger("exec:"+e,n,i,t)},o.wrapError(this,t),this.sync(e,this,t)},e.exports=r.Model.extend(s)},function(e,t){"use strict";var i=n(11),r=n(10),o=n(7),s=/[\:\*]([^\:\?\/]+)/g,a={componentsManager:o,namedParameters:!0,autoloadModules:!1,modulesPath:"modules/",defaultModuleName:"main",require:window.require,onModuleError:function(){}},c=["componentsManager","namedParameters","autoloadModules","modulesPath","defaultModuleName","require","onModuleError"];a.constructor=function(e){e=e||{},i.extend(this,i.pick(e,c)),this.options=e,this.modules={},r.Router.apply(this,arguments),this.autoloadModules&&this.route("*url",function(e){this.loadModule(e.url)})},a.component=function(e){return this.componentsManager.add(e)},a.route=function(e,t,n){var o=this;i.isFunction(t)&&(n=t,t={}),i.isObject(t)||(t={name:t});var s="";if(i.has(t,"components")||i.has(t,"component")){var a=i(t.components||[t.component]).map(function(e){return i.isString(e)?o.componentsManager.get(e):o.component(e)}),c=i.pluck(a,"name");s=c.join(","),n=function(){var e={data:{fragment:r.history.fragment,params:o.namedParameters?i.first(arguments):i.initial(arguments),query:i.last(arguments)}};o.componentsManager.load(c,{viewOptions:e})}}s=t.name||s,r.Router.prototype.route.call(this,e,s,n)},a._routeToRegExp=function(e){var t=e.match(s)||[];return e=r.Router.prototype._routeToRegExp.call(this,e),e.paramNames=i(t).map(function(e){return e.replace(/\)$/,"").substring(1)}),e},a._extractParameters=function(e,t){var n=r.Router.prototype._extractParameters.call(this,e,t);if(!this.namedParameters||!e.paramNames)return n;var o={},s=n.length;i(e.paramNames).find(function(e,t){return!(i.isString(n[t])&&t<s-1)||(o[e]=n[t],!1)});var a=n[s-1];return[o,a]},a.loadModule=function(e){var t=this;e=e||r.history.fragment;var n=this.getModuleName(e);this.modules[n]||this.require([this.modulesPath+n],function(){t.modules[n]=!0,r.history.loadUrl(e)},this.onModuleError)},a.getModuleName=function(e){return i(e.split("/")).find(i.identity)||this.defaultModuleName},e.exports=r.Router.extend(a)},function(e,t){"use strict";function i(e,t){var n=t.exclude,i=t.include;return Boolean(n&&r.contains(r.isArray(n)?n:[n],e)||i&&!r.contains(r.isArray(i)?i:[i],e))}var r=n(11),o=n(10),s=o.$,a=Array.prototype.splice,c=/^(\S+)\s*(.*)$/,h=/\s*,\s*/g,u={initialized:!1,templateHelpers:{},waitsCounter:0,waitAvailable:!0,attached:!1},l=["models","collections","views"],d=["modelEvents","collectionEvents","viewEvents"],p=["componentsManager","template","templateHelpers","ui","triggers"],f=["data","models","collections","model","collection"],m=r.union(l,d,p,f);u.constructor=function(e){var t=this;e=e||{},r.extend(this,r.pick(e,m)),this.options=e,this.data=r.result(this,"data",{}),this.templateData={},this._prepareEntityEvents(),this._prepareModels(),this._prepareCollections(),this._prepareViews(),r(this.views).each(function(e,n){t.delegateEntityEvents("views",n,e)}),o.View.call(this,r.omit(e,"model","collection")),r(this.views).each(function(e){r(e).each(function(e){e.isWaiting()&&t.listenToOnce(e,"resolved",t.wait())})}),this.waitAvailable=!1,r(this.collections).each(function(e,n){t.delegateEntityEvents("collections",n,e)}),this.collection&&this.delegateEntityEvents("collections","",this.collection),r(this.models).each(function(e,n){t.delegateEntityEvents("models",n,e)}),this.model&&this.delegateEntityEvents("models","",this.model),this.isWaiting()||(this.initialized=!0,r.defer(function(){t.trigger("initialized")}))},u.updateState=function(e,t){e=r({}).defaults(e,{data:{}}),t=r({}).defaults(t,{apply:!0});var n=this;return r(f).each(function(t){if(r.has(e,t)){var i,o,s;if(r.contains(["data","models","collections"],t)){if(o=e[t],!r.isObject(o))throw new Error("State property `"+t+"` should be an object");i=n[t],s=r.keys(o)}else i=n,o=e,s=[t];r(s).each(function(e){r.has(i,e)&&r.contains(["models","collections","model","collection"],t)&&n.undelegateEntityEvents(i[e]),i[e]=o[e],r.contains(["models","collections"],t)&&n.delegateEntityEvents(t,e,o[e]),r.contains(["model","collection"],t)&&n.delegateEntityEvents(t+"s","",o[e])})}}),t.apply&&this.applyState(),this},u.applyState=function(){var e=!1;if(this.template){var t=r.clone(this.getTemplateData());e=!this.isStatesEqual(this.templateData,t),e&&(this.templateData=t)}return e},u._update=function(){},u.update=function(e){if(!this.initialized)throw new Error("Method .update() is not available while view is not initialized");var t=this;return this.waitAvailable=!0,this.updateState(e,{apply:!1}),this._update(e),r(this.views).each(function(e){r(e).each(function(e){e.isWaiting()&&t.listenToOnce(e,"resolved",t.wait())})}),this.waitAvailable=!1,this.isWaiting()||r.defer(function(){t.trigger("updated")}),this},u.isStatesEqual=function(e,t){return r.isEqual(e,t)},u.wait=function(){if(!this.waitAvailable)throw new Error("Method .wait() is not available");var e=this;return++this.waitsCounter,r.once(function(){r.defer(function(){--e.waitsCounter,e.isWaiting()||(e.initialized?e.trigger("updated"):(e.initialized=!0,e.trigger("initialized")),e.trigger("resolved"))})})},u.isWaiting=function(){return this.waitsCounter>0},u.render=function(e){if(!this.initialized)return this;if(e=e||{},this.template){var t=this.applyState();if(e.force||!this.attached||t){this.detachViews(e),this.detach();var n=r(this).chain().result("templateHelpers").extend(this.templateData).value(),i=this._renderTemplate(this.template,n);if(!r.isString(i))throw new Error("`_renderTemplate` method should return a HTML string");var o=s(i);if(!o.length)throw new Error("View template produces empty html");if(o.length>1)throw new Error("View template produces html with more than one root elements");this.setElement(o)}}else this.$el.length||this._ensureElement();return this.trigger("render"),this.renderViews(e),this.parent&&!this.$el.parent().length||(this.attachViews(e),this.attach()),this},u.getTemplateData=function(){return{}},u._renderTemplate=function(e,t){if(!r.isFunction(e))throw new Error("View `template` should be a function");return e(t)},u.renderViews=function(e){var t=this;return r(this.views).each(function(n,o){if(!i(o,e)&&n.length){r(n).each(function(t){t.render(r.omit(e,"include","exclude"))});var s=o?t.$(o).first():t.$el;if(!s.length)throw new Error('Container "'+o+'" is not found');var a=s.get(0),c=r(n).some(function(e){var t=e.$el.parent().get(0);return!e.attached||!t||t!==a});if(c){var h=[];r(n).each(function(e){h.push(e.$el)}),s.append(h)}}}),this},u.setView=function(e,t,n){return this._setViews([e],t,n)},u.setViews=function(e,t,n){return this._setViews(e,t,n)},u.appendView=function(e,t,n){return n=r(n||{}).omit("at"),this._addViews([e],t,n)},u.appendViews=function(e,t,n){return n=r(n||{}).omit("at"),this._addViews(e,t,n)},u.prependView=function(e,t,n){return n=r.extend({},n,{at:0}),this._addViews([e],t,n)},u.prependViews=function(e,t,n){return n=r.extend({},n,{at:0}),this._addViews(e,t,n)},u.addView=function(e,t,n){return this._addViews([e],t,n)},u.addViews=function(e,t,n){return this._addViews(e,t,n)},u.removeView=function(e,t,n){if(arguments.length<2)throw new Error('"view" or "at" arguments must be specified');return r.isString(e)&&(n=t,t=e,e=this.getView(t,n),!e)?this:this._removeViews([e],t)},u.removeViews=function(e,t){return r.isString(e)&&(t=e,e=this.getViews(t)),this._removeViews(e,t)},u.getView=function(e,t){return this.getViews(e)[t||0]||null},u.getViews=function(e){return r.clone(this.views[e])||[]},u.getViewsCount=function(e){return(this.views[e]||[]).length},u._addViews=function(e,t,n){var i=this,o=this.getViews(t);return n=r.defaults({},n,{at:o.length}),r(e).each(function(e){e.parent&&e.parent.removeView(e,e.container)}),this.views[t]||(this.views[t]=[]),a.apply(this.views[t],[n.at,0].concat(e)),r(e).each(function(e){e.parent=i,e.container=t}),this.delegateEntityEvents("views",t,e),this},u._setViews=function(e,t,n){n=n||{};var i;if(r.isNumber(n.at)){var o=this.getView(t,n.at);i=o?[o]:[]}else i=this.getViews(t);return i.length===e.length&&r(i).all(function(t,n){return t===e[n]})?this:(i.length&&(this._removeViews(i,t),r(i).each(function(e){e.remove()})),this._addViews(e,t,n))},u._removeViews=function(e,t){var n=this,i=this.getViews(t);if(!i.length)return this;var o=r(e).chain().uniq().map(function(e){return{view:e,index:r.indexOf(i,e)}}).filter(function(e){return e.index>=0}).sortBy(function(e){return-e.index}).value();return o.length?(r(o).each(function(e){var i=e.view;a.call(n.views[t],e.index,1),n.undelegateEntityEvents(i),delete i.parent}),this):this},u.setElement=function(e){var t=this.$el;return this._setElement(e),t&&t.parent().length&&t.replaceWith(this.$el),this.ensureUI(),this},u.ensureUI=function(e){e=e||r.result(this,"ui",{});var t=this;return this.$ui=r(e).mapObject(function(e){return t.$(e)}),this},u.delegateTriggers=function(e){if(e=e||r.result(this,"triggers"),!e)return this;var t=this;return this.undelegateTriggers(),r(e).each(function(e,n){var i=n.match(c),o=i[1],s=i[2];t.delegateTrigger(o,s,r.bind(t.trigger,t,e))}),this},u.delegateTrigger=function(e,t,n){return this.$el.on(e+".delegateTriggers"+this.cid,t,n),this},u.undelegateTriggers=function(){return this.$el&&this.$el.off(".delegateTriggers"+this.cid),this},u.undelegateTrigger=function(e,t,n){return this.$el.off(e+".delegateTriggers"+this.cid,t,n),this},u.delegateEntityEvents=function(e,t,n){if(!r.has(this._entityEvents,e))throw new Error('Wrong entity type "'+e+'", available values: '+l.join(", "));var i=this;if(n||(n=this[e][t]),!n)return this;r.isArray(n)||(n=[n]);var o=this._entityEvents[e][t];return o&&(this.undelegateEntityEvents(n),r(o).each(function(e){r(n).each(function(t){i.listenTo(t,e.name,e.listener)})})),this},u.undelegateEntityEvents=function(e){var t=this;return r.isArray(e)||(e=[e]),r(e).each(function(e){t.stopListening(e)}),this},u._prepareEntityEvents=function(){var e=this;this._entityEvents={},r(l).each(function(t){e._entityEvents[t]={}}),r(d).each(function(t,n){var i=r.result(e,t);if(i){var o=l[n];e._addEntityEvents(o,i)}})},u._addEntityEvents=function(e,t){var n=this;r(t).each(function(t,i){if(r.isFunction(t)||(t=n[t]),t){var o=i.match(c),s=o[1],a=o[2].replace(h,",").split(",");t=r.bind(t,n),r(a).each(function(i){n._addEntityEvent(e,i,s,t)})}})},u._addEntityEvent=function(e,t,n,i){var r=this._entityEvents[e];r[t]=r[t]||[],r[t].push({name:n,listener:i})},u._prepareViews=function(){this.views=r.result(this,"views",{}),this.views=r(this.views).mapObject(function(e){return e?(e=r.isArray(e)?e:[e],r(e).map(function(e){return r.isFunction(e)?new e:e})):[]})},u._prepareModels=function(){this.models=r.result(this,"models",{}),this.models=r(this.models).mapObject(function(e){return r.isFunction(e)?new e:e}),this.model&&r.isFunction(this.model)&&(this.model=new this.model)},u._prepareCollections=function(){this.collections=r.result(this,"collections",{}),this.collections=r(this.collections).mapObject(function(e){return r.isFunction(e)?new e:e}),this.collection&&r.isFunction(this.collection)&&(this.collection=new this.collection)},u.attachViews=function(e){return e=e||{},r(this.views).each(function(t,n){i(n,e)||t.length&&r(t).each(function(t){t.attachViews(r.omit(e,"include","exclude")),t.attach()})}),this},u.beforeAttach=function(){return this},u.afterAttach=function(){return this},u.attach=function(){if(this.attached)return this;this.beforeAttach(),this.trigger("beforeAttach");var e=this.$el.data("esencia-view");return e&&(e.detachViews(),e.detach()),this.$el.data("esencia-view",this).attr("esencia-view",this.cid),this.delegateEvents(),this.delegateTriggers(),this.attached=!0,this.afterAttach(),this.trigger("afterAttach"),this},u.detachViews=function(e){return e=e||{},r(this.views).each(function(t,n){i(n,e)||t.length&&r(t).each(function(t){t.detachViews(r.omit(e,"include","exclude")),t.detach()})}),this},u.beforeDetach=function(){return this},u.afterDetach=function(){return this},u.detach=function(){return this.attached?(this.trigger("beforeDetach"),this.beforeDetach(),this.$el.removeData("esencia-view").removeAttr("esencia-view"),this.undelegateEvents(),this.undelegateTriggers(),this.attached=!1,this.trigger("afterDetach"),this.afterDetach(),this):this},u.remove=function(){return this.parent&&this.parent.removeView(this,this.container),this.detachViews(),this.detach(),o.View.prototype.remove.call(this)},u.getClosestView=function(e){var t=s(e);return t.is("[esencia-view]")||(t=t.closest("[esencia-view]")),t.length?t.data("esencia-view"):null},e.exports=o.View.extend(u)},function(e,t){"use strict";var i=n(10),r=n(11),o=n(4),s=n(0),a=n(3),c=n(5),h=n(1),u=n(2),l=n(7),d=n(9),p=t;r.extend(p,i.Events);var f=["Events","History","history"];r.extend(p,r.pick(i,f)),r.extend(p,{Router:o,Collection:s,Model:a,View:c,CollectionView:h,ComponentsManager:u}),p.componentsManager=l,p.extend=d},function(e,t){"use strict";var i=n(2);e.exports=new i},function(e,t){"use strict";var i=n(11),r="PUT",o=function(){throw new Error("A `url` property or function must be specified")};t.wrapError=function(e,t){var n=t.error;t.error=function(i){n&&n.call(t.context,e,i,t),e.trigger("error",e,i,t)}},t.prepareOptions=function(e,t,n){if(n=i.extend({type:r,dataType:"json",contentType:"application/json",processData:!1},n),!n.url){var s=i.result(t,"url")||o();n.url=s.replace(/[^\/]$/,"$&/")+e}return n.data&&i.isObject(n.data)&&!n.processData&&(n.data=JSON.stringify(n.data)),n};var s={POST:"create",PUT:"update",PATCH:"patch",DELETE:"delete",GET:"read"};t.baseMethods=i.values(s),t.getFakeBaseMethod=function(e){return s[e.type.toUpperCase()]}},function(e,t){"use strict";var i=n(10);e.exports=i.View.extend},function(e,n){e.exports=t},function(t,n){t.exports=e}],n(6)});
//# sourceMappingURL=esencia.min.js.map
