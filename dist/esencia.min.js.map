{"version":3,"sources":["esencia.js","lib/collection.js","lib/componentsManager.js","lib/esencia.js","lib/model.js","lib/router.js","lib/utils/exec.js","lib/view.js"],"names":["factory","define","amd","exports","module","require","this","Esencia","_","Backbone","__external__","__external_Backbone","_require","id","cache","modules","call","backbone","execUtils","Collection","sync","method","collection","options","prepareOptions","getFakeBaseMethod","prototype","exec","extend","parse","success","resp","fetch","reset","context","trigger","wrapError","View","ComponentsManager","pick","componentManagerOptions","components","componentsTree","initialize","apply","arguments","componentOptions","Events","rootComponentEl","addRootComponent","RootView","el","add","name","parent","defaults","process","component","isUndefined","uniqueId","isString","Error","isNull","get","remove","callback","noop","newComponentsTree","_calculateTree","_applyTree","parentNode","oldNode","node","child","_isTreeNodeChanged","view","attached","isUnchanged","params","self","iterateNode","childNode","onViewResolve","setData","container","setView","renderViews","attachViews","render","oldView","detach","chain","extendOwn","result","viewOptions","value","isWaiting","listenToOnce","oldChildViewContainer","oldChildView","removeView","Router","Model","model","serverAttrs","set","root","pushState","namedParameters","nowhereUrl","config","autoloadModules","modulesPath","defaultModuleName","onModuleError","routerOptions","constructor","componentsManager","router","urlParams","history","route","setModule","_populateUrlParams","key","has","filter","isObject","each","isFunction","url","defaultUrlParams","args","_defaultMiddleware","navigate","fragment","indexOf","substring","length","force","replace","omit","qs","toFragment","val","undefined","next","middleware","defaultMiddleware","moduleName","split","find","identity","moduleInit","start","DEFAULT_EXEC_TYPE","urlError","error","type","dataType","contentType","processData","data","JSON","stringify","baseMethodsMap","POST","PUT","PATCH","DELETE","GET","toUpperCase","$","splice","Array","delegateEventSplitter","nestedEventTypes","templateHelpers","waitsCounter","waitAvailable","views","collections","models","template","_prepareEvents","_prepareViews","wait","delegateNestedEvents","once","defer","_render","html","renderTemplate","getTemplateData","$el","setElement","_ensureElement","$container","attach","viewsGroup","first","containerEl","domChanged","some","$els","push","append","index","_updateViews","setViews","appendView","_insertViews","appendViews","prependView","prependViews","insertView","insertViews","getView","_removeViews","removeViews","getViews","clone","concat","removedViews","viewObjs","uniq","map","viewObj","sortBy","undelegateNestedEvents","element","$previousEl","_setElement","replaceWith","delegateEvents","events","entities","isArray","listeners","_nestedEventsHash","listener","entity","listenTo","eventName","handler","stopListening","typeEventsHash","match","entityKeys","bind","entityKey","afterAttach","previousView","attr","cid","detachViews","beforeDetach","removeData","removeAttr","undelegateEvents","getClosestView","selector","$selector","is","closest"],"mappings":"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","file":"esencia.min.js","sourcesContent":["(function (factory) {\n    if (typeof define === 'function' && define.amd) {\n        define([\n            'underscore',\n            'backbone'\n        ], factory);\n    } else if (typeof exports === 'object') {\n        module.exports = factory(require('underscore'), require('backbone'));\n    } else {\n        this.Esencia = factory(_, Backbone);\n    }\n}(function (__external__, __external_Backbone) {\n    var global = this, define;\n    function _require(id) {\n        var module = _require.cache[id];\n        if (!module) {\n            var exports = {};\n            module = _require.cache[id] = {\n                id: id,\n                exports: exports\n            };\n            _require.modules[id].call(exports, module, exports);\n        }\n        return module.exports;\n    }\n    _require.cache = [];\n    _require.modules = [\n        function (module, exports) {\n            'use strict';\n            var _ = _require(8);\n            var backbone = _require(7);\n            var execUtils = _require(5);\n            var Collection = {};\n            Collection.sync = function (method, collection, options) {\n                options = execUtils.prepareOptions(method, collection, options);\n                method = execUtils.getFakeBaseMethod(options);\n                return backbone.Collection.prototype.sync.call(this, method, collection, options);\n            };\n            Collection.exec = function (method, options) {\n                options = _.extend({ parse: true }, options);\n                var collection = this;\n                var success = options.success;\n                options.success = function (resp) {\n                    if (options.fetch)\n                        collection[options.reset ? 'reset' : 'set'](resp, options);\n                    if (success)\n                        success.call(options.context, collection, resp, options);\n                    collection.trigger('exec:' + method, collection, resp, options);\n                };\n                execUtils.wrapError(this, options);\n                return this.sync(method, this, options);\n            };\n            module.exports = backbone.Collection.extend(Collection);\n        },\n        function (module, exports) {\n            'use strict';\n            var _ = _require(8);\n            var backbone = _require(7);\n            var View = _require(6);\n            var ComponentsManager = function (options) {\n                _.extend(this, _.pick(options, componentManagerOptions));\n                this.options = options;\n                this.components = {};\n                this.componentsTree = null;\n                this.initialize.apply(this, arguments);\n            };\n            var componentManagerOptions = [\n                    'rootComponentEl',\n                    'viewOptions'\n                ];\n            var componentOptions = [\n                    'name',\n                    'parent',\n                    'container',\n                    'View',\n                    'models',\n                    'collections',\n                    'viewOptions'\n                ];\n            _.extend(ComponentsManager.prototype, backbone.Events, {\n                rootComponentEl: 'html',\n                initialize: function () {\n                },\n                addRootComponent: function () {\n                    var RootView = View.extend({ el: this.rootComponentEl });\n                    this.add({\n                        name: '',\n                        parent: null,\n                        View: RootView\n                    });\n                },\n                add: function (options) {\n                    options = _({}).defaults(options, {\n                        parent: '',\n                        process: false\n                    });\n                    var component = _(options).pick(componentOptions);\n                    if (_.isUndefined(component.name)) {\n                        component.name = _.uniqueId('auto-named-component');\n                    }\n                    if (!_.isString(component.name)) {\n                        throw new Error('Component `name` option should be a string');\n                    }\n                    if (component.name in this.components) {\n                        throw new Error('Duplicate component with name \"' + component.name + '\"');\n                    }\n                    if (!component.View) {\n                        throw new Error('Component `View` option is required');\n                    }\n                    if (!_.isString(component.parent) && !_.isNull(component.parent)) {\n                        throw new Error('Component `parent` option should be a string or null');\n                    }\n                    this.components[component.name] = component;\n                    if (options.process) {\n                        this.process(component.name);\n                    }\n                    return component;\n                },\n                get: function (name) {\n                    return this.components[name] || null;\n                },\n                remove: function (name) {\n                    delete this.components[name];\n                },\n                process: function (name, callback) {\n                    callback = callback || _.noop;\n                    var newComponentsTree = this._calculateTree(name);\n                    this._applyTree({\n                        parentNode: null,\n                        oldNode: this.componentsTree,\n                        node: newComponentsTree\n                    }, callback);\n                },\n                _calculateTree: function (name, child) {\n                    var component = this.components[name];\n                    if (!component) {\n                        throw new Error('Unknown component with name \"' + name + '\"');\n                    }\n                    var node = { name: name };\n                    if (child) {\n                        node.child = child;\n                    }\n                    if (_.isString(component.parent)) {\n                        return this._calculateTree(component.parent, node);\n                    } else {\n                        return node;\n                    }\n                },\n                _isTreeNodeChanged: function (oldNode, node) {\n                    if (!oldNode || oldNode.name !== node.name || !oldNode.view)\n                        return true;\n                    var component = this.components[node.name];\n                    if (oldNode.view instanceof component.View === false)\n                        return true;\n                    if (!oldNode.view.attached)\n                        return true;\n                    return !oldNode.view.isUnchanged();\n                },\n                _applyTree: function (params, callback) {\n                    var self = this;\n                    var parentNode = params.parentNode;\n                    var iterateNode = function (oldNode, node) {\n                        var childNode = node.child;\n                        delete node.child;\n                        if (parentNode) {\n                            parentNode.child = node;\n                        } else {\n                            self.componentsTree = node;\n                        }\n                        if (childNode) {\n                            self._applyTree({\n                                parentNode: node,\n                                oldNode: oldNode && oldNode.child || null,\n                                node: childNode\n                            }, callback);\n                        } else {\n                            callback();\n                        }\n                    };\n                    var node = params.node;\n                    var oldNode = params.oldNode;\n                    var component = this.components[node.name];\n                    var onViewResolve = function (view) {\n                        node.view = view;\n                        view.setData();\n                        if (component.container) {\n                            if (!parentNode) {\n                                throw new Error('Parent component should exist for component with `container` option');\n                            }\n                            parentNode.view.setView(view, component.container).renderViews().attachViews();\n                        } else {\n                            view.render();\n                        }\n                        iterateNode(null, node);\n                    };\n                    var oldView = oldNode && oldNode.view;\n                    if (this._isTreeNodeChanged(oldNode, node)) {\n                        if (oldView) {\n                            if (oldView.container) {\n                                if (!component.container || oldView.container !== component.container) {\n                                    oldView.remove();\n                                }\n                            } else {\n                                oldView.detach();\n                            }\n                        }\n                        var view = new component.View(_(component).chain().pick('models', 'collections').extendOwn(_(component).result('viewOptions'), this.viewOptions).value());\n                        if (view.isWaiting()) {\n                            self.listenToOnce(view, 'resolve', function () {\n                                onViewResolve(view);\n                            });\n                        } else {\n                            onViewResolve(view);\n                        }\n                    } else {\n                        var oldChildView = oldNode.child && oldNode.child.view;\n                        var oldChildViewContainer;\n                        if (oldChildView) {\n                            oldChildViewContainer = oldChildView.container;\n                            if (oldChildViewContainer) {\n                                oldView.removeView(oldChildView, oldChildViewContainer);\n                            }\n                        }\n                        node.view = oldView;\n                        oldView.setData();\n                        oldView.render();\n                        if (oldChildView && oldChildViewContainer) {\n                            oldView.setView(oldChildView, oldChildViewContainer);\n                        }\n                        iterateNode(oldNode, node);\n                    }\n                }\n            });\n            ComponentsManager.extend = View.extend;\n            module.exports = ComponentsManager;\n        },\n        function (module, exports) {\n            'use strict';\n            var Router = _require(4);\n            var Collection = _require(0);\n            var Model = _require(3);\n            var View = _require(6);\n            var ComponentsManager = _require(1);\n            module.exports.Router = Router;\n            module.exports.Collection = Collection;\n            module.exports.Model = Model;\n            module.exports.View = View;\n            module.exports.ComponentsManager = ComponentsManager;\n        },\n        function (module, exports) {\n            'use strict';\n            var _ = _require(8);\n            var backbone = _require(7);\n            var execUtils = _require(5);\n            var Model = {};\n            Model.sync = function (method, model, options) {\n                options = execUtils.prepareOptions(method, model, options);\n                method = execUtils.getFakeBaseMethod(options);\n                return backbone.Model.prototype.sync.call(this, method, model, options);\n            };\n            Model.exec = function (method, options) {\n                options = _.extend({ parse: true }, options);\n                var model = this;\n                var success = options.success;\n                options.success = function (resp) {\n                    if (options.fetch) {\n                        var serverAttrs = options.parse ? model.parse(resp, options) : resp;\n                        if (!model.set(serverAttrs, options))\n                            return false;\n                    }\n                    if (success)\n                        success.call(options.context, model, resp, options);\n                    model.trigger('exec:' + method, model, resp, options);\n                };\n                execUtils.wrapError(this, options);\n                return this.sync(method, this, options);\n            };\n            module.exports = backbone.Model.extend(Model);\n        },\n        function (module, exports) {\n            'use strict';\n            var _ = _require(8);\n            var backbone = _require(7);\n            var ComponentsManager = _require(1);\n            var Router = {\n                    root: '/',\n                    pushState: false,\n                    namedParameters: false,\n                    nowhereUrl: '___',\n                    config: {},\n                    autoloadModules: true,\n                    modulesPath: 'modules/',\n                    defaultModuleName: 'main',\n                    onModuleError: function () {\n                    }\n                };\n            var routerOptions = [\n                    'root',\n                    'pushState',\n                    'namedParameters',\n                    'nowhereUrl',\n                    'config',\n                    'autoloadModules',\n                    'modulesPath',\n                    'defaultModuleName',\n                    'onModuleError'\n                ];\n            Router.constructor = function (options) {\n                options = options || {};\n                _.extend(this, _.pick(options, routerOptions));\n                this.options = options;\n                this.componentsManager = new ComponentsManager(_.extend({}, options, { viewOptions: { router: this } }));\n                this.urlParams = {};\n                this.modules = {};\n                this.history = backbone.history;\n                backbone.Router.namedParameters = this.namedParameters;\n                backbone.Router.apply(this, arguments);\n                if (options.autoloadModules) {\n                    this.route('*url', function (params) {\n                        this.setModule(params);\n                    });\n                }\n            };\n            Router._populateUrlParams = function () {\n                var self = this;\n                var key;\n                for (key in this.urlParams) {\n                    if (_(this.urlParams).has(key)) {\n                        delete this.urlParams[key];\n                    }\n                }\n                _(arguments).chain().filter(_.isObject).each(function (params) {\n                    params = _.isFunction(params) ? params.call(self) : params;\n                    _.extendOwn(self.urlParams, params);\n                });\n                return this.urlParams;\n            };\n            Router.component = function (options) {\n                var self = this;\n                var component = this.componentsManager.add(options);\n                if (!_.isUndefined(options.url)) {\n                    this.route(options.url, component.name, function (params) {\n                        self._populateUrlParams(options.defaultUrlParams, params);\n                        self.componentsManager.process(component.name);\n                    });\n                }\n            };\n            Router.route = function (url, name, callback) {\n                var router = this;\n                if (_.isFunction(name)) {\n                    callback = name;\n                    name = '';\n                }\n                backbone.Router.prototype.route.call(this, url, name, function () {\n                    var args = arguments;\n                    router._defaultMiddleware({\n                        url: url,\n                        name: name,\n                        callback: callback\n                    }, function () {\n                        callback.apply(router, args);\n                    });\n                });\n            };\n            Router.navigate = function (fragment, options) {\n                options = options || {};\n                if (fragment.indexOf(this.root) === 0) {\n                    fragment = fragment.substring(this.root.length);\n                }\n                if (options.force) {\n                    this.navigate(this.nowhereUrl, {\n                        replace: options.replace,\n                        trigger: false\n                    });\n                    options = _(options).chain().omit('force').extend({ replace: true }).value();\n                    return this.navigate(fragment, options);\n                }\n                options = _(options || {}).defaults({\n                    trigger: true,\n                    params: {}\n                });\n                var qs = options.qs;\n                if (this.toFragment && qs) {\n                    _(qs).each(function (val, key, qs) {\n                        if (val === undefined || val === null)\n                            delete qs[key];\n                    });\n                    fragment = this.toFragment(fragment, qs);\n                    delete options.qs;\n                }\n                backbone.Router.prototype.navigate.call(this, fragment, options);\n            };\n            Router._defaultMiddleware = function (route, next) {\n                next();\n            };\n            Router.middleware = function (middleware) {\n                var router = this;\n                var defaultMiddleware = this._defaultMiddleware;\n                this._defaultMiddleware = function (route, next) {\n                    defaultMiddleware.call(router, route, function () {\n                        middleware.call(router, route, next);\n                    });\n                };\n                return this;\n            };\n            Router.setModule = function (params) {\n                var router = this;\n                var url = params.url;\n                delete params.url;\n                var moduleName = _(url.split('/')).find(_.identity) || this.defaultModuleName;\n                require([this.modulesPath + moduleName], function (moduleInit) {\n                    if (!router.modules[moduleName]) {\n                        moduleInit(router);\n                        router.modules[moduleName] = true;\n                        router.navigate(url, {\n                            replace: true,\n                            force: true,\n                            qs: params\n                        });\n                    }\n                }, this.onModuleError);\n            };\n            Router.start = function () {\n                this.componentsManager.addRootComponent();\n                backbone.history.start({\n                    pushState: this.pushState,\n                    root: this.root\n                });\n            };\n            module.exports = backbone.Router.extend(Router);\n        },\n        function (module, exports) {\n            'use strict';\n            var _ = _require(8);\n            var DEFAULT_EXEC_TYPE = 'PUT';\n            var urlError = function () {\n                throw new Error('A \"url\" property or function must be specified');\n            };\n            module.exports.wrapError = function (model, options) {\n                var error = options.error;\n                options.error = function (resp) {\n                    if (error)\n                        error.call(options.context, model, resp, options);\n                    model.trigger('error', model, resp, options);\n                };\n            };\n            module.exports.prepareOptions = function (method, model, options) {\n                options = _({\n                    type: DEFAULT_EXEC_TYPE,\n                    dataType: 'json',\n                    contentType: 'application/json',\n                    processData: false\n                }).extend(options);\n                if (!options.url) {\n                    var url = _.result(model, 'url') || urlError();\n                    options.url = url.replace(/[^\\/]$/, '$&/') + method;\n                }\n                if (options.data && _.isObject(options.data) && !options.processData) {\n                    options.data = JSON.stringify(options.data);\n                }\n                return options;\n            };\n            var baseMethodsMap = {\n                    'POST': 'create',\n                    'PUT': 'update',\n                    'PATCH': 'patch',\n                    'DELETE': 'delete',\n                    'GET': 'read'\n                };\n            module.exports.getFakeBaseMethod = function (options) {\n                return baseMethodsMap[options.type.toUpperCase()];\n            };\n        },\n        function (module, exports) {\n            'use strict';\n            var _ = _require(8);\n            var backbone = _require(7);\n            var $ = backbone.$;\n            var splice = Array.prototype.splice;\n            var delegateEventSplitter = /^(\\S+)\\s*(.*)$/;\n            var nestedEventTypes = [\n                    'views',\n                    'collections',\n                    'models'\n                ];\n            var View = {\n                    templateHelpers: {},\n                    waitsCounter: 0,\n                    waitAvailable: true,\n                    attached: false\n                };\n            var viewOptions = [\n                    'views',\n                    'collections',\n                    'models',\n                    'data',\n                    'events',\n                    'router',\n                    'templateHelpers'\n                ];\n            View.constructor = function (options) {\n                var self = this;\n                options = options || {};\n                this.views = {};\n                this.collections = {};\n                this.models = {};\n                this.data = {};\n                _.extend(this, _.pick(options, viewOptions));\n                this.options = options;\n                if (this.template && !_.isFunction(this.template)) {\n                    throw new Error('View `template` option should be a function');\n                }\n                this._prepareEvents();\n                this._prepareViews();\n                backbone.View.apply(this, arguments);\n                _(this.views).each(function (views) {\n                    _(views).each(function (view) {\n                        if (view.isWaiting()) {\n                            self.listenToOnce(view, 'resolve', self.wait());\n                        }\n                    });\n                });\n                this.waitAvailable = false;\n                _(this.collections).each(function (collection, key) {\n                    self.delegateNestedEvents('collections', key, collection);\n                });\n                _(this.models).each(function (model, key) {\n                    self.delegateNestedEvents('models', key, model);\n                });\n            };\n            View.setData = function (data) {\n                if (data)\n                    this.data = data;\n                return this;\n            };\n            View.isUnchanged = function () {\n                return true;\n            };\n            View.wait = function () {\n                if (!this.waitAvailable) {\n                    throw new Error('Method .wait() is available only in the constructor');\n                }\n                var self = this;\n                this.waitsCounter++;\n                return _.once(function () {\n                    _.defer(function () {\n                        self.waitsCounter--;\n                        if (!self.isWaiting()) {\n                            self.trigger('resolve');\n                        }\n                    });\n                });\n            };\n            View.isWaiting = function () {\n                return this.waitsCounter > 0;\n            };\n            View._render = function (options) {\n                if (this.isWaiting())\n                    return this;\n                options = options || {};\n                if (this.template) {\n                    if (options.force || !this.attached || !this.isUnchanged()) {\n                        this.detach();\n                        var html = this.renderTemplate(this.template, this.getTemplateData());\n                        var $el = $(html);\n                        if (!$el.length) {\n                            throw new Error('View template produces empty html');\n                        }\n                        if ($el.length > 1) {\n                            throw new Error('View template produces html with more than one root elements');\n                        }\n                        this.setElement($el);\n                    }\n                } else {\n                    if (!this.$el.length)\n                        this._ensureElement();\n                }\n                this.renderViews(options);\n                if (!this.parent || this.$container) {\n                    this.attachViews();\n                    this.attach();\n                }\n                return this;\n            };\n            View.render = function (options) {\n                return this._render(options);\n            };\n            View.getTemplateData = function () {\n                return this.data;\n            };\n            View.renderTemplate = function (template, data) {\n                data = _(this).chain().result('templateHelpers').extend(data).value();\n                return template(data);\n            };\n            View.renderViews = function (options) {\n                var self = this;\n                _(this.views).each(function (viewsGroup, container) {\n                    if (!viewsGroup.length)\n                        return;\n                    _(viewsGroup).each(function (view) {\n                        view.render(options);\n                    });\n                    var $container = container ? self.$(container).first() : self.$el;\n                    if (!$container.length) {\n                        throw new Error('Container \"' + container + '\" is not found');\n                    }\n                    var containerEl = $container.get(0);\n                    var domChanged = _(viewsGroup).some(function (view) {\n                            return !view.attached || !view.$container || view.$container.get(0) !== containerEl;\n                        });\n                    if (domChanged) {\n                        var $els = [];\n                        _(viewsGroup).each(function (view) {\n                            view.$container = $container;\n                            $els.push(view.$el);\n                        });\n                        $container.append($els);\n                    }\n                });\n                return this;\n            };\n            View.setView = function (view, container, index) {\n                return this._updateViews([view], container, index);\n            };\n            View.setViews = function (views, container, index) {\n                return this._updateViews(views, container, index);\n            };\n            View.appendView = function (view, container) {\n                return this._insertViews([view], container);\n            };\n            View.appendViews = function (views, container) {\n                return this._insertViews(views, container);\n            };\n            View.prependView = function (view, container) {\n                return this._insertViews([view], container, 0);\n            };\n            View.prependViews = function (views, container) {\n                return this._insertViews(views, container, 0);\n            };\n            View.insertView = function (view, container, index) {\n                return this._insertViews([view], container, index);\n            };\n            View.insertViews = function (views, container, index) {\n                return this._insertViews(views, container, index);\n            };\n            View.removeView = function (view, container, index) {\n                if (arguments.length < 2) {\n                    throw new Error('\"view\" or \"index\" arguments must be specified');\n                }\n                if (_.isString(view)) {\n                    index = container;\n                    container = view;\n                    view = this.getView(container, index);\n                    if (!view)\n                        return this;\n                }\n                return this._removeViews([view], container);\n            };\n            View.removeViews = function (views, container) {\n                if (_.isString(views)) {\n                    container = views;\n                    views = this.getViews(container);\n                }\n                return this._removeViews(views, container);\n            };\n            View.getView = function (container, index) {\n                return this.getViews(container)[index || 0] || null;\n            };\n            View.getViews = function (container) {\n                return _.clone(this.views[container]) || [];\n            };\n            View._insertViews = function (views, container, index) {\n                var self = this;\n                var viewsGroup = this.getViews(container);\n                _(views).each(function (view) {\n                    if (view.parent) {\n                        view.parent.removeView(view, view.container);\n                    }\n                });\n                if (viewsGroup.length) {\n                    if (typeof index === 'undefined') {\n                        index = viewsGroup.length;\n                    }\n                    splice.apply(this.views[container], [\n                        index,\n                        0\n                    ].concat(views));\n                } else {\n                    this.views[container] = views;\n                }\n                _(views).each(function (view) {\n                    view.parent = self;\n                    view.container = container;\n                });\n                this.delegateNestedEvents('views', container, views);\n                return this;\n            };\n            View._updateViews = function (views, container, index) {\n                var viewsGroup = this.getViews(container);\n                if (viewsGroup.length) {\n                    var removedViews = [];\n                    if (typeof index !== 'undefined') {\n                        removedViews = this.getView(container, index);\n                        removedViews = removedViews ? [removedViews] : [];\n                    } else {\n                        removedViews = viewsGroup;\n                    }\n                    if (removedViews.length) {\n                        this._removeViews(removedViews, container);\n                        _(removedViews).each(function (view) {\n                            view.remove();\n                        });\n                    }\n                }\n                return this._insertViews(views, container, index);\n            };\n            View._removeViews = function (views, container) {\n                var self = this;\n                var viewsGroup = this.getViews(container);\n                if (!viewsGroup.length)\n                    return this;\n                var viewObjs = _.chain(views).uniq().map(function (view) {\n                        return {\n                            view: view,\n                            index: _.indexOf(viewsGroup, view)\n                        };\n                    }).filter(function (viewObj) {\n                        return viewObj.index >= 0;\n                    }).sortBy(function (viewObj) {\n                        return -viewObj.index;\n                    }).value();\n                if (!viewObjs.length)\n                    return this;\n                _(viewObjs).each(function (viewObj) {\n                    var view = viewObj.view;\n                    splice.call(self.views[container], viewObj.index, 1);\n                    self.undelegateNestedEvents(view);\n                    delete view.parent;\n                });\n                return this;\n            };\n            View.setElement = function (element) {\n                var $previousEl = this.$el;\n                this._setElement(element);\n                if ($previousEl && this.$container) {\n                    $previousEl.replaceWith(this.$el);\n                }\n                return this;\n            };\n            View.delegateEvents = function (events) {\n                events = events || _.result(this, 'events');\n                if (!events)\n                    return this;\n                events = _(events).omit(nestedEventTypes);\n                return backbone.View.prototype.delegateEvents.call(this, events);\n            };\n            View.delegateNestedEvents = function (type, key, entities) {\n                var self = this;\n                if (!_.isArray(entities))\n                    entities = [entities];\n                var listeners = this._nestedEventsHash[type][key];\n                if (listeners) {\n                    _(listeners).each(function (listener) {\n                        _(entities).each(function (entity) {\n                            self.listenTo(entity, listener.eventName, listener.handler);\n                        });\n                    });\n                }\n                return this;\n            };\n            View.undelegateNestedEvents = function (entities) {\n                var self = this;\n                if (!_.isArray(entities))\n                    entities = [entities];\n                _(entities).each(function (entity) {\n                    self.stopListening(entity);\n                });\n                return this;\n            };\n            View._prepareEvents = function (events) {\n                var self = this;\n                this._nestedEventsHash = {};\n                _(nestedEventTypes).each(function (type) {\n                    self._nestedEventsHash[type] = {};\n                });\n                events = events || _.result(this, 'events');\n                if (!events)\n                    return;\n                _(nestedEventTypes).each(function (type) {\n                    var typeEventsHash = self._nestedEventsHash[type];\n                    if (!_(events).has(type) || !_.isObject(events[type]))\n                        return;\n                    _(events[type]).each(function (method, key) {\n                        if (!_.isFunction(method))\n                            method = self[method];\n                        if (!method)\n                            return;\n                        var match = key.match(delegateEventSplitter);\n                        var eventName = match[1];\n                        var entityKeys = match[2].replace(/ *, */g, ',').split(',');\n                        method = _.bind(method, self);\n                        _(entityKeys).each(function (entityKey) {\n                            typeEventsHash[entityKey] = typeEventsHash[entityKey] || [];\n                            typeEventsHash[entityKey].push({\n                                eventName: eventName,\n                                handler: method\n                            });\n                        });\n                    });\n                });\n            };\n            View._prepareViews = function () {\n                var self = this;\n                _(this.views).each(function (views, container) {\n                    if (!_.isArray(views))\n                        views = [views];\n                    self.views[container] = views;\n                    self.delegateNestedEvents('views', container, views);\n                });\n            };\n            View.attachViews = function () {\n                _(this.views).each(function (viewsGroup) {\n                    if (!viewsGroup.length)\n                        return;\n                    _(viewsGroup).each(function (view) {\n                        view.attachViews();\n                        view.attach();\n                    });\n                });\n                return this;\n            };\n            View.afterAttach = function () {\n                return this;\n            };\n            View.attach = function () {\n                if (this.attached)\n                    return this;\n                var previousView = this.$el.data('esencia-view');\n                if (previousView)\n                    previousView.detach();\n                this.$el.data('esencia-view', this).attr('esencia-view', this.cid);\n                this.delegateEvents();\n                this.attached = true;\n                this.afterAttach();\n                this.trigger('attach');\n                return this;\n            };\n            View.detachViews = function () {\n                _(this.views).each(function (viewsGroup) {\n                    if (!viewsGroup.length)\n                        return;\n                    _(viewsGroup).each(function (view) {\n                        view.detachViews();\n                        view.detach();\n                    });\n                });\n                return this;\n            };\n            View.beforeDetach = function () {\n                return this;\n            };\n            View.detach = function () {\n                if (!this.attached)\n                    return this;\n                this.trigger('detach');\n                this.beforeDetach();\n                this.$el.removeData('esencia-view').removeAttr('esencia-view');\n                this.undelegateEvents();\n                this.attached = false;\n                return this;\n            };\n            View.remove = function () {\n                if (this.parent) {\n                    this.parent.removeView(this, this.container);\n                }\n                this.detachViews();\n                this.detach();\n                return backbone.View.prototype.remove.call(this);\n            };\n            View.getClosestView = function (selector) {\n                var $selector = $(selector);\n                if (!$selector.is('[esencia-view]')) {\n                    $selector = $selector.closest('[esencia-view]');\n                }\n                return $selector.length ? $selector.data('esencia-view') : null;\n            };\n            module.exports = backbone.View.extend(View);\n        },\n        function (module, exports) {\n            module.exports = __external_Backbone;\n        },\n        function (module, exports) {\n            module.exports = __external__;\n        }\n    ];\n    return _require(2);\n}));\n//# sourceMappingURL=esencia.js.map\n","'use strict';\n\nvar _ = require('underscore');\nvar backbone = require('backbone');\nvar execUtils = require('./utils/exec');\n\nvar Collection = {};\n\n/*\n * Override `sync` to add exec custom method functionality\n */\n\nCollection.sync = function(method, collection, options) {\n\toptions = execUtils.prepareOptions(method, collection, options);\n\tmethod = execUtils.getFakeBaseMethod(options);\n\treturn backbone.Collection.prototype.sync.call(\n\t\tthis, method, collection, options\n\t);\n};\n\n/*\n * Exec custom non-REST method on collection\n * It trigger `exec:[method]` event after success method exec\n *\n * @param {String} method\n * @param {Object} options\n */\n\nCollection.exec = function(method, options) {\n\toptions = _.extend({parse: true}, options);\n\tvar collection = this;\n\tvar success = options.success;\n\toptions.success = function(resp) {\n\t\tif (options.fetch) collection[options.reset ? 'reset' : 'set'](resp, options);\n\t\tif (success) success.call(options.context, collection, resp, options);\n\t\tcollection.trigger('exec:' + method, collection, resp, options);\n\t};\n\texecUtils.wrapError(this, options);\n\treturn this.sync(method, this, options);\n};\n\nmodule.exports = backbone.Collection.extend(Collection);\n","'use strict';\n\nvar _ = require('underscore');\nvar backbone = require('backbone');\nvar View = require('./view');\n\nvar ComponentsManager = function(options) {\n\t// populate ComponentsManager instance with fields from options\n\t_.extend(this, _.pick(options, componentManagerOptions));\n\t// save original options, it is sometimes usefull\n\tthis.options = options;\n\n\t// all components hash\n\tthis.components = {};\n\n\t// current components tree that rendered at this moment\n\tthis.componentsTree = null;\n\n\tthis.initialize.apply(this, arguments);\n};\n\nvar componentManagerOptions = ['rootComponentEl', 'viewOptions'];\n\n var componentOptions = [\n\t'name', 'parent', 'container', 'View', 'models', 'collections', 'viewOptions'\n];\n\n_.extend(ComponentsManager.prototype, backbone.Events, {\n\trootComponentEl: 'html',\n\n\t/*\n\t * Initialize is an empty function by default. Override it with your own\n\t * initialization logic.\n\t */\n\n\tinitialize: function() {},\n\n\t/*\n\t * Add root component to components list\n\t */\n\n\taddRootComponent: function() {\n\t\tvar RootView = View.extend({\n\t\t\tel: this.rootComponentEl\n\t\t});\n\n\t\tthis.add({\n\t\t\tname: '',\n\t\t\tparent: null,\n\t\t\tView: RootView\n\t\t});\n\t},\n\n\t/*\n\t * Add component to components list\n\t *\n\t * @param {Object} options - component options\n\t */\n\n\tadd: function(options) {\n\t\toptions = _({}).defaults(options, {\n\t\t\tparent: '',\n\t\t\tprocess: false\n\t\t});\n\n\t\tvar component = _(options).pick(componentOptions);\n\n\t\t// generate uniq component name if name is omitted\n\t\tif (_.isUndefined(component.name)) {\n\t\t\tcomponent.name = _.uniqueId('auto-named-component');\n\t\t}\n\n\t\tif (!_.isString(component.name)) {\n\t\t\tthrow new Error('Component `name` option should be a string');\n\t\t}\n\n\t\tif (component.name in this.components) {\n\t\t\tthrow new Error('Duplicate component with name \"' + component.name + '\"');\n\t\t}\n\n\t\tif (!component.View) {\n\t\t\tthrow new Error('Component `View` option is required');\n\t\t}\n\n\t\tif (!_.isString(component.parent) && !_.isNull(component.parent)) {\n\t\t\tthrow new Error('Component `parent` option should be a string or null');\n\t\t}\n\n\t\tthis.components[component.name] = component;\n\n\t\t// process components tree in force mode\n\t\tif (options.process) {\n\t\t\tthis.process(component.name);\n\t\t}\n\n\t\treturn component;\n\t},\n\n\t/*\n\t * Get component by name\n\t *\n\t * @param {String} name - component name\n\t */\n\n\tget: function(name) {\n\t\treturn this.components[name] || null;\n\t},\n\n\t/*\n\t * Remove component by name\n\t *\n\t * @param {String} name - component name\n\t */\n\n\tremove: function(name) {\n\t\tdelete this.components[name];\n\t},\n\n\t/*\n\t * Process components tree and call a callback on done\n\t *\n\t * @param {String} name - component name\n\t * @params {Function} callback\n\t */\n\n\tprocess: function(name, callback) {\n\t\tcallback = callback || _.noop;\n\n\t\tvar newComponentsTree = this._calculateTree(name);\n\n\t\tthis._applyTree({\n\t\t\tparentNode: null,\n\t\t\toldNode: this.componentsTree,\n\t\t\tnode: newComponentsTree\n\t\t}, callback);\n\t},\n\n\t_calculateTree: function(name, child) {\n\t\tvar component = this.components[name];\n\n\t\tif (!component) {\n\t\t\tthrow new Error('Unknown component with name \"' + name + '\"');\n\t\t}\n\n\t\tvar node = {name: name};\n\t\tif (child) {\n\t\t\tnode.child = child;\n\t\t}\n\n\t\tif (_.isString(component.parent)) {\n\t\t\treturn this._calculateTree(component.parent, node);\n\t\t} else {\n\t\t\treturn node;\n\t\t}\n\t},\n\n\t_isTreeNodeChanged: function(oldNode, node) {\n\t\tif (!oldNode || oldNode.name !== node.name || !oldNode.view) return true;\n\t\tvar component = this.components[node.name];\n\t\tif (oldNode.view instanceof component.View === false) return true;\n\t\tif (!oldNode.view.attached) return true;\n\t\treturn !oldNode.view.isUnchanged();\n\t},\n\n\t_applyTree: function(params, callback) {\n\t\tvar self = this;\n\n\t\tvar parentNode = params.parentNode;\n\n\t\tvar iterateNode = function(oldNode, node) {\n\t\t\t// omit child field in new node because it will set recursive\n\t\t\t// and should not exist if error case\n\t\t\tvar childNode = node.child;\n\t\t\tdelete node.child;\n\n\t\t\tif (parentNode) {\n\t\t\t\tparentNode.child = node;\n\t\t\t} else {\n\t\t\t\tself.componentsTree = node;\n\t\t\t}\n\n\t\t\tif (childNode) {\n\t\t\t\tself._applyTree({\n\t\t\t\t\tparentNode: node,\n\t\t\t\t\toldNode: oldNode && oldNode.child || null,\n\t\t\t\t\tnode: childNode\n\t\t\t\t}, callback);\n\t\t\t} else {\n\t\t\t\tcallback();\n\t\t\t}\n\t\t};\n\n\t\tvar node = params.node;\n\t\tvar oldNode = params.oldNode;\n\t\tvar component = this.components[node.name];\n\n\t\tvar onViewResolve = function(view) {\n\t\t\tnode.view = view;\n\t\t\tview.setData();\n\n\t\t\tif (component.container) {\n\t\t\t\tif (!parentNode) {\n\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t'Parent component should exist for component with `container` option'\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tparentNode.view\n\t\t\t\t\t.setView(view, component.container)\n\t\t\t\t\t.renderViews()\n\t\t\t\t\t.attachViews();\n\t\t\t} else {\n\t\t\t\tview.render();\n\t\t\t}\n\n\t\t\t// stop processing old components tree\n\t\t\titerateNode(null, node);\n\t\t};\n\n\t\t// get view from old node\n\t\tvar oldView = oldNode && oldNode.view;\n\n\t\tif (this._isTreeNodeChanged(oldNode, node)) {\n\t\t\tif (oldView) {\n\t\t\t\tif (oldView.container) {\n\t\t\t\t\t// remove old view if container for new view dirrent\n\t\t\t\t\tif (!component.container || oldView.container !== component.container) {\n\t\t\t\t\t\toldView.remove();\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t// detach old view if it has not a container\n\t\t\t\t\toldView.detach();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// create new view\n\t\t\tvar view = new (component.View)(\n\t\t\t\t_(component)\n\t\t\t\t\t.chain()\n\t\t\t\t\t.pick('models', 'collections')\n\t\t\t\t\t.extendOwn(_(component).result('viewOptions'), this.viewOptions)\n\t\t\t\t\t.value()\n\t\t\t);\n\n\t\t\tif (view.isWaiting()) {\n\t\t\t\t// wait when view will be resolved\n\t\t\t\tself.listenToOnce(view, 'resolve', function() {\n\t\t\t\t\tonViewResolve(view);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tonViewResolve(view);\n\t\t\t}\n\t\t} else {\n\t\t\t// get old child view if exists\n\t\t\tvar oldChildView = oldNode.child && oldNode.child.view;\n\n\t\t\t// temporary remove child node view from container\n\t\t\t// to prevent recursive renderViews\n\t\t\tvar oldChildViewContainer;\n\t\t\tif (oldChildView) {\n\t\t\t\toldChildViewContainer = oldChildView.container;\n\n\t\t\t\tif (oldChildViewContainer) {\n\t\t\t\t\toldView.removeView(oldChildView, oldChildViewContainer);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// save old view to new node\n\t\t\tnode.view = oldView;\n\n\t\t\t// set data and re-render old view\n\t\t\toldView.setData();\n\t\t\toldView.render();\n\n\t\t\t// revert child node view\n\t\t\tif (oldChildView && oldChildViewContainer) {\n\t\t\t\toldView.setView(oldChildView, oldChildViewContainer);\n\t\t\t}\n\n\t\t\t// proprocessing old components tree\n\t\t\titerateNode(oldNode, node);\n\t\t}\n\t}\n});\n\n/*\n * There is no good exports of extend method from backbone.\n * Take it from View and add to ComponentsManager\n *  because no other ways, ughh :-S.\n */\n\nComponentsManager.extend = View.extend;\n\nmodule.exports = ComponentsManager;\n","'use strict';\n\nvar Router = require('./router');\nvar Collection = require('./collection');\nvar Model = require('./model');\nvar View = require('./view');\nvar ComponentsManager = require('./componentsManager');\n\nmodule.exports.Router = Router;\nmodule.exports.Collection = Collection;\nmodule.exports.Model = Model;\nmodule.exports.View = View;\nmodule.exports.ComponentsManager = ComponentsManager;\n","'use strict';\n\nvar _ = require('underscore');\nvar backbone = require('backbone');\nvar execUtils = require('./utils/exec');\n\nvar Model = {};\n\n/*\n * Override `sync` to add exec custom method functionality\n */\n\nModel.sync = function(method, model, options) {\n\toptions = execUtils.prepareOptions(method, model, options);\n\tmethod = execUtils.getFakeBaseMethod(options);\n\treturn backbone.Model.prototype.sync.call(this, method, model, options);\n};\n\n/*\n * Exec custom non-REST method on model\n * It trigger `exec:[method]` event after success method exec\n *\n * @param {String} method\n * @param {Object} options\n */\n\nModel.exec = function(method, options) {\n\toptions = _.extend({parse: true}, options);\n\tvar model = this;\n\tvar success = options.success;\n\toptions.success = function(resp) {\n\t\tif (options.fetch) {\n\t\t\tvar serverAttrs = options.parse ? model.parse(resp, options) : resp;\n\t\t\tif (!model.set(serverAttrs, options)) return false;\n\t\t}\n\t\tif (success) success.call(options.context, model, resp, options);\n\t\tmodel.trigger('exec:' + method, model, resp, options);\n\t};\n\texecUtils.wrapError(this, options);\n\treturn this.sync(method, this, options);\n};\n\nmodule.exports = backbone.Model.extend(Model);\n","'use strict';\n\nvar _ = require('underscore');\nvar backbone = require('backbone');\nvar ComponentsManager = require('./componentsManager');\n\n/**\n * Router extends default backbone Router\n */\n\nvar Router = {\n\troot: '/',\n\tpushState: false,\n\tnamedParameters: false,\n\tnowhereUrl: '___',\n\tconfig: {},\n\tautoloadModules: true,\n\tmodulesPath: 'modules/',\n\tdefaultModuleName: 'main',\n\tonModuleError: function() {}\n};\n\nvar routerOptions = [\n\t'root', 'pushState', 'namedParameters', 'nowhereUrl', 'config',\n\t'autoloadModules', 'modulesPath', 'defaultModuleName', 'onModuleError'\n];\n\n/*\n * @constructor\n * @param {Object} [options]\n */\n\nRouter.constructor = function(options) {\n\toptions = options || {};\n\n\t// populate Router instance with fields from options\n\t_.extend(this, _.pick(options, routerOptions));\n\t// save original options, it is sometimes usefull\n\tthis.options = options;\n\n\tthis.componentsManager = new ComponentsManager(\n\t\t_.extend({}, options, {viewOptions: {router: this}})\n\t);\n\n\tthis.urlParams = {};\n\tthis.modules = {};\n\n\tthis.history = backbone.history;\n\n\t/*\n\t * All query parameters can be passed in a single hash using the key\n\t * referenced from the route definition (backbone queryparams will\n\t * do it for us)\n\t */\n\n\tbackbone.Router.namedParameters = this.namedParameters;\n\n\tbackbone.Router.apply(this, arguments);\n\n\tif (options.autoloadModules) {\n\t\tthis.route('*url', function(params) {\n\t\t\tthis.setModule(params);\n\t\t});\n\t}\n};\n\n/*\n * Extend all arguments to single object and replace urlParams with it\n *\n * @param {Object | Function} params1\n * @param {Object | Function} params2\n * etc. ...\n */\n\nRouter._populateUrlParams = function(/* params1, params2, ... */) {\n\tvar self = this;\n\n\t// clean old values from urlParams object\n\tvar key;\n\tfor (key in this.urlParams) {\n\t\tif (_(this.urlParams).has(key)) {\n\t\t\tdelete this.urlParams[key];\n\t\t}\n\t}\n\n\t// populate urlParams with new params\n\t_(arguments)\n\t\t.chain()\n\t\t.filter(_.isObject)\n\t\t.each(function(params) {\n\t\t\tparams = _.isFunction(params) ? params.call(self) : params;\n\t\t\t_.extendOwn(self.urlParams, params);\n\t\t});\n\n\treturn this.urlParams;\n};\n\n/*\n * Add new component to components manager\n *\n * @param {Object} options - component options\n */\n\nRouter.component = function(options) {\n\tvar self = this;\n\n\tvar component = this.componentsManager.add(options);\n\n\t// bind component to route\n\tif (!_.isUndefined(options.url)) {\n\t\tthis.route(options.url, component.name, function(params) {\n\t\t\tself._populateUrlParams(options.defaultUrlParams, params);\n\n\t\t\t// process components tree\n\t\t\tself.componentsManager.process(component.name);\n\t\t});\n\t}\n};\n\n/*\n * Override `route` to add middleware processing functionality\n */\n\nRouter.route = function(url, name, callback) {\n\tvar router = this;\n\n\tif (_.isFunction(name)) {\n\t\tcallback = name;\n\t\tname = '';\n\t}\n\n\tbackbone.Router.prototype.route.call(this, url, name, function() {\n\t\tvar args = arguments;\n\n\t\trouter._defaultMiddleware({\n\t\t\turl: url,\n\t\t\tname: name,\n\t\t\tcallback: callback\n\t\t}, function() {\n\t\t\tcallback.apply(router, args);\n\t\t});\n\t});\n};\n\n/*\n * Override `navigate`\n *\n * @param {String} fragment\n * @param {Object} [options] - hash of params\n * @param {Object} [options.qs] - query string hash\n */\n\nRouter.navigate = function(fragment, options) {\n\toptions = options || {};\n\n\tif (fragment.indexOf(this.root) === 0) {\n\t\tfragment = fragment.substring(this.root.length);\n\t}\n\n\t// force to go to the selected fragment even if we currently on it\n\tif (options.force) {\n\t\tthis.navigate(this.nowhereUrl, {\n\t\t\treplace: options.replace,\n\t\t\ttrigger: false\n\t\t});\n\n\t\toptions = _(options).chain().omit('force').extend({replace: true}).value();\n\n\t\treturn this.navigate(fragment, options);\n\t}\n\n\t// set `trigger` to true by default\n\toptions = _(options || {}).defaults({\n\t\ttrigger: true,\n\t\tparams: {}\n\t});\n\n\t// add support of query string using `toFragment` from backbone.queryparams\n\tvar qs = options.qs;\n\n\tif (this.toFragment && qs) {\n\t\t// reject undefined and null qs parameters\n\t\t_(qs).each(function(val, key, qs) {\n\t\t\tif (val === undefined || val === null) delete qs[key];\n\t\t});\n\n\t\tfragment = this.toFragment(fragment, qs);\n\n\t\tdelete options.qs;\n\t}\n\n\tbackbone.Router.prototype.navigate.call(this, fragment, options);\n};\n\n\n/*\n * Default middleware function\n */\n\nRouter._defaultMiddleware = function(route, next) {\n\tnext();\n};\n\n/**\n * Use passed function as `middleware`\n *\n * @param {Function} middleware - middleware function,\n * `route` and `next` will be passed as arguments.\n * context (`this`) is link to the router object.\n */\n\nRouter.middleware = function(middleware) {\n\tvar router = this;\n\n\tvar defaultMiddleware = this._defaultMiddleware;\n\n\tthis._defaultMiddleware = function(route, next) {\n\t\tdefaultMiddleware.call(router, route, function() {\n\t\t\tmiddleware.call(router, route, next);\n\t\t});\n\t};\n\n\treturn this;\n};\n\n/*\n * Require module file and init it\n *\n * @param {String} params.url Url without query string\n */\n\nRouter.setModule = function(params) {\n\tvar router = this;\n\n\tvar url = params.url;\n\tdelete params.url;\n\n\tvar moduleName = _(url.split('/')).find(_.identity) || this.defaultModuleName;\n\n\t// require module file\n\trequire([this.modulesPath + moduleName], function(moduleInit) {\n\t\t// if module is loaded first time\n\t\tif (!router.modules[moduleName]) {\n\t\t\t// init it\n\t\t\tmoduleInit(router);\n\n\t\t\t// set module init flag to true\n\t\t\trouter.modules[moduleName] = true;\n\n\t\t\t// and navigate again with force flag\n\t\t\trouter.navigate(url, {\n\t\t\t\treplace: true,\n\t\t\t\tforce: true,\n\t\t\t\tqs: params\n\t\t\t});\n\t\t}\n\t}, this.onModuleError);\n};\n\n/*\n * Start routes handling\n */\n\nRouter.start = function() {\n\tthis.componentsManager.addRootComponent();\n\n\tbackbone.history.start({\n\t\tpushState: this.pushState,\n\t\troot: this.root\n\t});\n};\n\nmodule.exports = backbone.Router.extend(Router);\n","'use strict';\n\nvar _ = require('underscore');\n\n// Default http method type for exec methods\nvar DEFAULT_EXEC_TYPE = 'PUT';\n\n// Throw an error when a URL is needed, and none is supplied.\nvar urlError = function() {\n\tthrow new Error('A \"url\" property or function must be specified');\n};\n\n// Wrap an optional error callback with a fallback error event.\nmodule.exports.wrapError = function(model, options) {\n\tvar error = options.error;\n\toptions.error = function(resp) {\n\t\tif (error) error.call(options.context, model, resp, options);\n\t\tmodel.trigger('error', model, resp, options);\n\t};\n};\n\nmodule.exports.prepareOptions = function(method, model, options) {\n\toptions = _({\n\t\ttype: DEFAULT_EXEC_TYPE,\n\t\tdataType: 'json',\n\t\tcontentType: 'application/json',\n\t\tprocessData: false\n\t}).extend(options);\n\n\t// Ensure that we have a URL and add method name to it\n\tif (!options.url) {\n\t\tvar url = _.result(model, 'url') || urlError();\n\t\toptions.url = url.replace(/[^\\/]$/, '$&/') + method;\n\t}\n\n\t// stringify data to json\n\tif (options.data && _.isObject(options.data) && !options.processData) {\n\t\toptions.data = JSON.stringify(options.data);\n\t}\n\n\treturn options;\n};\n\n// HTTP type to backbone sync methods map\nvar baseMethodsMap = {\n\t'POST': 'create',\n\t'PUT': 'update',\n\t'PATCH': 'patch',\n\t'DELETE': 'delete',\n\t'GET': 'read'\n};\n\nmodule.exports.getFakeBaseMethod = function(options) {\n\treturn baseMethodsMap[options.type.toUpperCase()];\n};\n","'use strict';\n\nvar _ = require('underscore');\nvar backbone = require('backbone');\n\n// Take jquery or other selectors lib from backbone\nvar $ = backbone.$;\n\nvar splice = Array.prototype.splice;\n\n// Cached regex to split keys for `delegate`.\nvar delegateEventSplitter = /^(\\S+)\\s*(.*)$/;\n\n// List of events type for nested entities processed by current view\nvar nestedEventTypes = ['views', 'collections', 'models'];\n\n/**\n * @class Esencia.View\n * @extend Backbone.View\n */\n\nvar View = {\n\t// Helpers (Object|Fuction) which will be passed to the template\n\ttemplateHelpers: {},\n\n\t// views are in the resolved state by default\n\twaitsCounter: 0,\n\n\t// this flag is used to check that .wait() is called\n\t// in the constructor/initialize\n\twaitAvailable: true,\n\n\t// views are not attached by default\n\tattached: false\n};\n\nvar viewOptions = [\n\t'views', 'collections', 'models', 'data', 'events', 'router', 'templateHelpers'\n];\n\n/**\n * @constructor\n * @param {Object} [options]\n */\n\nView.constructor = function(options) {\n\tvar self = this;\n\n\toptions = options || {};\n\n\t// nested views, collections, models and data are empty by default\n\tthis.views = {};\n\tthis.collections = {};\n\tthis.models = {};\n\tthis.data = {};\n\n\t// populate View instance with fields from options\n\t_.extend(this, _.pick(options, viewOptions));\n\t// save original options, it is sometimes usefull\n\tthis.options = options;\n\n\tif (this.template && !_.isFunction(this.template)) {\n\t\tthrow new Error('View `template` option should be a function');\n\t}\n\n\t// create special hash object for all events for fast search\n\tthis._prepareEvents();\n\n\t// normalize nested views hash\n\tthis._prepareViews();\n\n\t// apply default backbone.View constructor\n\tbackbone.View.apply(this, arguments);\n\n\t// set waiting state for current view if some nested view is in waiting state\n\t_(this.views).each(function(views) {\n\t\t_(views).each(function(view) {\n\t\t\tif (view.isWaiting()) {\n\t\t\t\tself.listenToOnce(view, 'resolve', self.wait());\n\t\t\t}\n\t\t});\n\t});\n\n\t// disable .wait(), it available only in the constructor/initialize\n\tthis.waitAvailable = false;\n\n\t// we should delegate events after parent constructor call because\n\t// collections and models could be created in the initialize method\n\n\t// delegate events for each collection\n\t_(this.collections).each(function(collection, key) {\n\t\tself.delegateNestedEvents('collections', key, collection);\n\t});\n\n\t// delegate events for each model\n\t_(this.models).each(function(model, key) {\n\t\tself.delegateNestedEvents('models', key, model);\n\t});\n};\n\n/**\n * Update view data\n * Method is used to update view state, could be overriden to modify nested\n * views state\n *\n * @param {Object} [data] - new data object\n * @return {Esencia.View} - view instance for chaining\n */\n\nView.setData = function(data) {\n\tif (data) this.data = data;\n\treturn this;\n};\n\n/**\n * Check that view is changed and should be re-rendered\n * Method returns true by default (always unchanged), could be overriden\n * for specific logic\n *\n * @return {Boolean}\n */\n\nView.isUnchanged = function() {\n\treturn true;\n};\n\n/**\n * Switch view to the waiting state\n *\n * @return {Function} - callback function, should be called to resolve view\n */\n\nView.wait = function() {\n\tif (!this.waitAvailable) {\n\t\tthrow new Error('Method .wait() is available only in the constructor');\n\t}\n\n\tvar self = this;\n\n\tthis.waitsCounter++;\n\n\t// TODO: think about promises\n\treturn _.once(function() {\n\t\t_.defer(function() {\n\t\t\tself.waitsCounter--;\n\t\t\tif (!self.isWaiting()) {\n\t\t\t\tself.trigger('resolve');\n\t\t\t}\n\t\t});\n\t});\n};\n\n/**\n * @return {Boolean}\n */\n\nView.isWaiting = function() {\n\treturn this.waitsCounter > 0;\n};\n\n/**\n * Render view\n *\n * @override render\n * @param {Object} options\n * @param {Boolean} options.force\n * @return {Esencia.View} - view instance for chaining\n */\n\nView._render = function(options) {\n\t// stop rendering if view in `waiting` state, resolve it first\n\tif (this.isWaiting()) return this;\n\n\toptions = options || {};\n\n\tif (this.template) {\n\t\t// re-render template only if it exists and if it is necessary\n\t\tif (options.force || !this.attached || !this.isUnchanged()) {\n\t\t\t// detach view from DOM element\n\t\t\tthis.detach();\n\n\t\t\t// render template with data\n\t\t\tvar html = this.renderTemplate(this.template, this.getTemplateData());\n\n\t\t\t// render html with jqeury (or other lib) call\n\t\t\tvar $el = $(html);\n\n\t\t\tif (!$el.length) {\n\t\t\t\tthrow new Error('View template produces empty html');\n\t\t\t}\n\n\t\t\tif ($el.length > 1) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t'View template produces html with more than one root elements'\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tthis.setElement($el);\n\t\t}\n\t} else {\n\t\t// re-ensure element if it is not ensured\n\t\tif (!this.$el.length) this._ensureElement();\n\t}\n\n\t// render nested views\n\tthis.renderViews(options);\n\n\tif (!this.parent || this.$container) {\n\t\t// attach all nested views first\n\t\tthis.attachViews();\n\n\t\t// attach current view\n\t\tthis.attach();\n\t}\n\n\t// return this for chaining\n\treturn this;\n};\n\n/**\n * Render view by calling private _render method\n *\n * @override render\n * @return {Esencia.View} - view instance for chaining\n */\n\nView.render = function(options) {\n\treturn this._render(options);\n};\n\n/*\n * Get data for template rendering\n * Returns data by default, could be overriden\n *\n * @return {Object}\n */\n\nView.getTemplateData = function() {\n\treturn this.data;\n};\n\n/*\n * Render template with data. Returns html.\n *\n * @param {Function} template - template function for rendering\n * @param {Object} data - data for rendering\n * @return {String} - rendered html\n */\n\nView.renderTemplate = function(template, data) {\n\tdata = _(this).chain().result('templateHelpers').extend(data).value();\n\n\t// get html\n\treturn template(data);\n};\n\n/*\n * Render all nested view\n *\n * @param {Object} options\n * @param {Boolean} options.force\n * @return {Esencia.View} - view instance for chaining\n*/\n\nView.renderViews = function(options) {\n\tvar self = this;\n\n\t// iterate by each views group\n\t_(this.views).each(function(viewsGroup, container) {\n\t\t// return if view group is empty\n\t\tif (!viewsGroup.length) return;\n\n\t\t// call render for each views from view group\n\t\t_(viewsGroup).each(function(view) {\n\t\t\tview.render(options);\n\t\t});\n\n\t\t// get first container or $el\n\t\tvar $container = container ? self.$(container).first() : self.$el;\n\n\t\tif (!$container.length) {\n\t\t\tthrow new Error('Container \"' + container + '\" is not found');\n\t\t}\n\n\t\tvar containerEl = $container.get(0);\n\n\t\t// dom is changed if some view from group is not in current container\n\t\tvar domChanged = _(viewsGroup).some(function(view) {\n\t\t\treturn (\n\t\t\t\t!view.attached ||\n\t\t\t\t!view.$container ||\n\t\t\t\tview.$container.get(0) !== containerEl\n\t\t\t);\n\t\t});\n\n\t\tif (domChanged) {\n\t\t\t// re-append views group to container\n\t\t\tvar $els = [];\n\n\t\t\t_(viewsGroup).each(function(view) {\n\t\t\t\tview.$container = $container;\n\t\t\t\t$els.push(view.$el);\n\t\t\t});\n\n\t\t\t// TODO: add some rendering optimizations here\n\n\t\t\t// put all views to $container\n\t\t\t$container.append($els);\n\t\t}\n\t});\n\n\t// return this for chaining\n\treturn this;\n};\n\n/*\n * Set view to views group or replace some view in specified position\n * If index is passed it replace only one view with index in views group\n *\n * @param {Esencia.View} view - view to set\n * @param {String} container - container to set\n * @param {Number} [index] - index of view to replace\n * @return {Esencia.View} - view instance for chaining\n */\n\nView.setView = function(view, container, index) {\n\treturn this._updateViews([view], container, index);\n};\n\n/*\n * Set views to views group or replace some view in specified position\n * If index is passed it replace only one view with index in views group\n *\n * @param {Esencia.View[]} views - views to set\n * @param {String} container - container to set\n * @param {Number} [index] - index of view to replace\n * @return {Esencia.View} - view instance for chaining\n */\n\nView.setViews = function(views, container, index) {\n\treturn this._updateViews(views, container, index);\n};\n\n/*\n * Append view to end of views group\n * This method is alias for insertView without index argument\n *\n * @param {Esencia.View} view - view to append\n * @param {String} container - container of views group\n * @return {Esencia.View} - view instance for chaining\n */\n\nView.appendView = function(view, container) {\n\treturn this._insertViews([view], container);\n};\n\n/*\n * Append views to end of views group\n * This method is alias for insertViews without index argument\n *\n * @param {Esencia.View[]} views - views to append\n * @param {String} container - container of views group\n * @return {Esencia.View} - view instance for chaining\n */\n\nView.appendViews = function(views, container) {\n\treturn this._insertViews(views, container);\n};\n\n/*\n * Prepend view to start of views group\n * This method is alias for insertView with `0` as index argument value\n *\n * @param {Esencia.View} view - view to prepend\n * @param {String} container - container of views group\n * @return {Esencia.View} - view instance for chaining\n */\n\nView.prependView = function(view, container) {\n\treturn this._insertViews([view], container, 0);\n};\n\n/*\n * Prepend views to start of views group\n * This method is alias for insertViews with `0` as index argument value\n *\n * @param {Esencia.View[]} views - view to prepend\n * @param {String} container - container of views group\n  * @return {Esencia.View} - view instance for chaining\n */\n\nView.prependViews = function(views, container) {\n\treturn this._insertViews(views, container, 0);\n};\n\n/*\n * Insert view to specified position of views group in the container\n * If index is not passed method inserts view to the end of views group (append)\n *\n * @param {Esencia.View} view - view to insert\n * @param {String} container - container of views group\n * @param {Number} [index] - position in views group\n * @return {Esencia.View} - view instance for chaining\n */\n\nView.insertView = function(view, container, index) {\n\treturn this._insertViews([view], container, index);\n};\n\n/*\n * Insert views to specified position of views group container\n * If index is not passed method inserts views to the end of views group\n *\n * @param {Esencia.View[]} views - views to insert\n * @param {String} container - container of views group\n * @param {Number} [index] - position in views group\n * @return {Esencia.View} - view instance for chaining\n */\n\nView.insertViews = function(views, container, index) {\n\treturn this._insertViews(views, container, index);\n};\n\n/*\n * Remove view from views group container by index or view instance\n * If index is passed it remove view in the index position\n *\n * @param {Esencia.View} [view] - view to remove\n * @param {String} container - container of views group\n * @param {Number} [index] - index of view in views group\n * @return {Esencia.View} - view instance for chaining\n */\n\nView.removeView = function(view, container, index) {\n\tif (arguments.length < 2) {\n\t\tthrow new Error('\"view\" or \"index\" arguments must be specified');\n\t}\n\n\tif (_.isString(view)) {\n\t\tindex = container;\n\t\tcontainer = view;\n\t\tview = this.getView(container, index);\n\t\tif (!view) return this;\n\t}\n\n\treturn this._removeViews([view], container);\n};\n\n/*\n * Remove views from views group container\n * If views are passed remove only these views\n * Othervise remove all views from container\n *\n * @param {Esencia.View[]} [views] - views to remove\n * @param {String} container - container of views group\n * @return {Esencia.View} - view instance for chaining\n */\n\nView.removeViews = function(views, container) {\n\tif (_.isString(views)) {\n\t\tcontainer = views;\n\t\tviews = this.getViews(container);\n\t}\n\n\treturn this._removeViews(views, container);\n};\n\n/*\n * Get single view from container by index\n *\n * @param {String} container - container of views group\n * @param {Number} [index] - index of view in views group\n * @return {Esencia.View}\n */\n\nView.getView = function(container, index) {\n\treturn this.getViews(container)[index || 0] || null;\n};\n\n/*\n * Get views group from container\n *\n * @param {String} container - container of views group\n * @return {Esencia.View[]}\n */\n\nView.getViews = function(container) {\n\treturn _.clone(this.views[container]) || [];\n};\n\nView._insertViews = function(views, container, index) {\n\tvar self = this;\n\n\tvar viewsGroup = this.getViews(container);\n\n\t_(views).each(function(view) {\n\t\tif (view.parent) {\n\t\t\tview.parent.removeView(view, view.container);\n\t\t}\n\t});\n\n\tif (viewsGroup.length) {\n\t\t// if index is not specified set it value as last index of views group\n\t\tif (typeof index === 'undefined') {\n\t\t\tindex = viewsGroup.length;\n\t\t}\n\n\t\t// insert views\n\t\tsplice.apply(this.views[container], [index, 0].concat(views));\n\t} else {\n\t\t// if group is empty - set views as whole views group value\n\t\tthis.views[container] = views;\n\t}\n\n\t// set each view parent to current\n\t_(views).each(function(view) {\n\t\tview.parent = self;\n\t\tview.container = container;\n\t});\n\n\tthis.delegateNestedEvents('views', container, views);\n\n\treturn this;\n};\n\nView._updateViews = function(views, container, index) {\n\tvar viewsGroup = this.getViews(container);\n\n\tif (viewsGroup.length) {\n\t\tvar removedViews = [];\n\n\t\t// if views group is not empty\n\t\tif (typeof index !== 'undefined') {\n\t\t\t// if index is specified\n\t\t\t// remove view from specific position\n\t\t\tremovedViews = this.getView(container, index);\n\t\t\tremovedViews = removedViews ? [removedViews] : [];\n\t\t} else {\n\t\t\t// if no index - remove all views from views group\n\t\t\tremovedViews = viewsGroup;\n\t\t}\n\n\t\tif (removedViews.length) {\n\t\t\t// if remove views array is not empty\n\t\t\t// remove from parent\n\t\t\tthis._removeViews(removedViews, container);\n\n\t\t\t// and remove views\n\t\t\t_(removedViews).each(function(view) {\n\t\t\t\tview.remove();\n\t\t\t});\n\t\t}\n\t}\n\n\t// insert new views\n\treturn this._insertViews(views, container, index);\n};\n\nView._removeViews = function(views, container) {\n\tvar self = this;\n\n\tvar viewsGroup = this.getViews(container);\n\n\tif (!viewsGroup.length) return this;\n\n\tvar viewObjs = _.chain(views).uniq().map(function(view) {\n\t\t\treturn {\n\t\t\t\tview: view,\n\t\t\t\tindex: _.indexOf(viewsGroup, view)\n\t\t\t};\n\t\t}).filter(function(viewObj) {\n\t\t\treturn viewObj.index >= 0;\n\t\t}).sortBy(function(viewObj) {\n\t\t\treturn -viewObj.index;\n\t\t}).value();\n\n\tif (!viewObjs.length) return this;\n\n\t_(viewObjs).each(function(viewObj) {\n\t\tvar view = viewObj.view;\n\n\t\t// remove item from group\n\t\tsplice.call(self.views[container], viewObj.index, 1);\n\n\t\t// undelegate all nested entity events\n\t\tself.undelegateNestedEvents(view);\n\n\t\t// unset view parent\n\t\tdelete view.parent;\n\t});\n\n\treturn this;\n};\n\n/*\n * Original setElement do undelegateEvents/delegateEvents, we remove it\n * because we have special detach/attach methods for this purpose\n *\n * @override setElement\n * @return {Esencia.View} - view instance for chaining\n */\n\nView.setElement = function(element) {\n\tvar $previousEl = this.$el;\n\n\tthis._setElement(element);\n\n\t// insert html to $el\n\tif ($previousEl && this.$container) {\n\t\t$previousEl.replaceWith(this.$el);\n\t}\n\n\treturn this;\n};\n\n/*\n * @override delegateEvents\n */\n\nView.delegateEvents = function(events) {\n\tevents = events || _.result(this, 'events');\n\tif (!events) return this;\n\tevents = _(events).omit(nestedEventTypes);\n\treturn backbone.View.prototype.delegateEvents.call(this, events);\n};\n\nView.delegateNestedEvents = function(type, key, entities) {\n\tvar self = this;\n\tif (!_.isArray(entities)) entities = [entities];\n\tvar listeners = this._nestedEventsHash[type][key];\n\tif (listeners) {\n\t\t_(listeners).each(function(listener) {\n\t\t\t_(entities).each(function(entity) {\n\t\t\t\tself.listenTo(entity, listener.eventName, listener.handler);\n\t\t\t});\n\t\t});\n\t}\n\treturn this;\n};\n\nView.undelegateNestedEvents = function(entities) {\n\tvar self = this;\n\tif (!_.isArray(entities)) entities = [entities];\n\t_(entities).each(function(entity) {\n\t\tself.stopListening(entity);\n\t});\n\treturn this;\n};\n\nView._prepareEvents = function(events) {\n\tvar self = this;\n\n\t// Hash for nested views events fast search\n\tthis._nestedEventsHash = {};\n\t_(nestedEventTypes).each(function(type) {\n\t\tself._nestedEventsHash[type] = {};\n\t});\n\n\tevents = events || _.result(this, 'events');\n\tif (!events) return;\n\n\t// bind all prefixed events to view then call native delegate events\n\t_(nestedEventTypes).each(function(type) {\n\t\tvar typeEventsHash = self._nestedEventsHash[type];\n\n\t\tif (!_(events).has(type) || !_.isObject(events[type])) return;\n\n\t\t_(events[type]).each(function(method, key) {\n\t\t\tif (!_.isFunction(method)) method = self[method];\n\t\t\tif (!method) return;\n\t\t\tvar match = key.match(delegateEventSplitter);\n\t\t\tvar eventName = match[1];\n\t\t\tvar entityKeys = match[2].replace(/ *, */g, ',').split(',');\n\t\t\tmethod = _.bind(method, self);\n\n\t\t\t// fill _nestedEventsHash\n\t\t\t_(entityKeys).each(function(entityKey) {\n\t\t\t\ttypeEventsHash[entityKey] = typeEventsHash[entityKey] || [];\n\t\t\t\ttypeEventsHash[entityKey].push({\n\t\t\t\t\teventName: eventName,\n\t\t\t\t\thandler: method\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t});\n};\n\n/*\n * Wrap all non-array view groups to arrays with one element and delegate events\n */\n\nView._prepareViews = function() {\n\tvar self = this;\n\n\t_(this.views).each(function(views, container) {\n\t\tif (!_.isArray(views)) views = [views];\n\t\tself.views[container] = views;\n\t\tself.delegateNestedEvents('views', container, views);\n\t});\n};\n\n/**\n * Attach all nested views\n *\n * @return {Esencia.View} - view instance for chaining\n */\n\nView.attachViews = function() {\n\t// iterate by each nested views groups\n\t_(this.views).each(function(viewsGroup) {\n\t\t// return if views group is empty\n\t\tif (!viewsGroup.length) return;\n\n\t\t// call attach method for each nested view from views group\n\t\t_(viewsGroup).each(function(view) {\n\t\t\t// recursive attach all nested views\n\t\t\tview.attachViews();\n\n\t\t\t// attach current view\n\t\t\tview.attach();\n\t\t});\n\t});\n\n\t// return this for chaining\n\treturn this;\n};\n\n/*\n * afterAttach is empty by default\n * It called after attach call, could be verriden to add some specific logic\n * for DOM manipulations\n *\n * @return {Esencia.View} - view instance for chaining\n */\n\nView.afterAttach = function() {\n\treturn this;\n};\n\n/*\n * Attach new view to current view $el\n *\n * @return {Esencia.View} - view instance for chaining\n */\n\nView.attach = function() {\n\t// return if current view is already attached\n\tif (this.attached) return this;\n\n\t// detach previous view\n\tvar previousView = this.$el.data('esencia-view');\n\tif (previousView) previousView.detach();\n\n\t// attach current view and set attr\n\tthis.$el.data('esencia-view', this).attr('esencia-view', this.cid);\n\n\t// enable all DOM events\n\tthis.delegateEvents();\n\n\tthis.attached = true;\n\n\t// do some user afterAttach actions\n\tthis.afterAttach();\n\n\t// trigger attach event\n\tthis.trigger('attach');\n\n\treturn this;\n};\n\n/**\n * Detach all nested views\n *\n * @return {Esencia.View} - view instance for chaining\n */\n\nView.detachViews = function() {\n\t// iterate by each views groups\n\t_(this.views).each(function(viewsGroup) {\n\t\t// return if views group is empty\n\t\tif (!viewsGroup.length) return;\n\n\t\t// call detach method for each nested view from views group\n\t\t_(viewsGroup).each(function(view) {\n\t\t\t// recursive detach all nested views\n\t\t\tview.detachViews();\n\n\t\t\t// detach current view\n\t\t\tview.detach();\n\t\t});\n\t});\n\n\t// return this for chaining\n\treturn this;\n};\n\n/*\n * beforeDetach is empty by default\n * It called before detach method call, could be overriden to add some specific\n * logic before view detach from dom\n *\n * @return {Esencia.View} - view instance for chaining\n */\n\nView.beforeDetach = function() {\n\treturn this;\n};\n\n/*\n * Detach view from current view $el\n *\n * @return {Esencia.View} - view instance for chaining\n */\n\nView.detach = function() {\n\t// return if current view is not already attached\n\tif (!this.attached) return this;\n\n\t// trigger detach event\n\tthis.trigger('detach');\n\n\t// do some user beforeDetach actions\n\tthis.beforeDetach();\n\n\t// remove attr and data from $el\n\tthis.$el.removeData('esencia-view').removeAttr('esencia-view');\n\n\t// disable all DOM events\n\tthis.undelegateEvents();\n\n\tthis.attached = false;\n\n\t// return this for chaining\n\treturn this;\n};\n\n/**\n * Remove view from parent container and remove element from DOM\n */\n\nView.remove = function() {\n\t// remove current view from parent view container\n\tif (this.parent) {\n\t\tthis.parent.removeView(this, this.container);\n\t}\n\n\t// detach all nested views first\n\tthis.detachViews();\n\n\t// detach current view\n\tthis.detach();\n\n\t// remove DOM element\n\treturn backbone.View.prototype.remove.call(this);\n};\n\n/*\n * Get view, that attached to closest element with attr `esencia-view`\n *\n * @param {String | $} selector\n * @return {Esencia.View | Null}\n */\n\nView.getClosestView = function(selector) {\n\tvar $selector = $(selector);\n\n\tif (!$selector.is('[esencia-view]')) {\n\t\t$selector = $selector.closest('[esencia-view]');\n\t}\n\n\treturn $selector.length ? $selector.data('esencia-view') : null;\n};\n\nmodule.exports = backbone.View.extend(View);\n"],"sourceRoot":"."}