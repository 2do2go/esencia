!function(e){"function"==typeof define&&define.amd?define(["underscore","backbone"],e):"object"==typeof exports?module.exports=e(require("underscore"),require("backbone")):this.Esencia.View=e(_,Backbone)}(function(e,t){function i(e){var t=i.cache[e];if(!t){var n={};t=i.cache[e]={id:e,exports:n},i.modules[e].call(n,t,n)}return t.exports}return i.cache=[],i.modules=[function(e,t){"use strict";var n=i(2),s=i(1),r=s.$,a=Array.prototype.splice,h=/^(\S+)\s*(.*)$/,o=["views","collections","models"],c={templateHelpers:{}},u=["models","collections","views","events","data","router","templateHelpers"];c.constructor=function(e){var t=this;if(e=e||{},this.views={},this.data=this.data||{},n.extend(this,n.pick(e,u)),this.options=e,this.template&&!n.isFunction(this.template))throw new Error("View `template` option should be a function");this._normalizeViews(),this._prepareNestedEvents(),this.waiting=!1,this.attached=!1,s.View.apply(this,arguments),this.collections&&n(this.collections).each(function(e,i){t.delegateNestedEvents("collections",i,e)}),this.models&&n(this.models).each(function(e,i){t.delegateNestedEvents("models",i,e)})},c.setData=function(e){e&&(this.data=e)},c.isUnchanged=function(){return!0},c.wait=function(){var e=this;return this.waiting=!0,function(){e.waiting=!1,e.trigger("resolve")}},c.render=function(e){if(console.log(">>>      render: %o %o",this,this.$el),this.waiting)return this;if(e=e||{},this.template){if(e.force||!this.attached||!this.isUnchanged()){this.detach();var t=this.renderTemplate(this.template,this.getTemplateData()),i=r(t);if(!i.length)throw new Error("View template produce empty html");if(i.length>1)throw new Error("View template produce html with more than one root elements");this.setElement(i)}}else this.$el.length||this._ensureElement();return this.renderViews(e),this.parent&&!this.$container||(this.attachViews(),this.attach()),this},c.getTemplateData=function(){return this.data},c.renderTemplate=function(e,t){return t=n(this).chain().result("templateHelpers").extend(t).value(),e(t)},c.renderViews=function(e){console.log(">>> renderViews: %o %o",this,this.$el);var t=this;return n(this.views).each(function(i,s){if(i.length){n(i).each(function(t){t.render(e)});var r=s?t.$(s).first():t.$el;if(!r.length)throw new Error('Container "'+s+'" is not found');var a=r.get(0),h=n(i).some(function(e){return!e.attached||!e.$container||e.$container.get(0)!==a});if(h){var o=[];n(i).each(function(e){e.$container=r,o.push(e.$el)}),r.append(o)}}}),this},c.setView=function(e,t,i){return this._updateViews([e],t,i)},c.setViews=function(e,t,i){return this._updateViews(e,t,i)},c.replaceView=function(e,t,i){return this._updateViews([e],t,i)},c.replaceViews=function(e,t,i){return this._updateViews(e,t,i)},c.appendView=function(e,t){return this._insertViews([e],t)},c.appendViews=function(e,t){return this._insertViews(e,t)},c.prependView=function(e,t){return this._insertViews([e],t,0)},c.prependViews=function(e,t){return this._insertViews(e,t,0)},c.insertView=function(e,t,i){return this._insertViews([e],t,i)},c.insertViews=function(e,t,i){return this._insertViews(e,t,i)},c.removeView=function(e,t,i){if(arguments.length<2)throw new Error('"view" or "index" arguments must be specified');return n.isString(e)&&(i=t,t=e,e=this.getView(t,i),!e)?this:this._removeViews([e],t)},c.removeViews=function(e,t){return n.isString(e)&&(t=e,e=this.getViews(t)),this._removeViews(e,t)},c.getView=function(e,t){return this.getViews(e)[t||0]||null},c.getViews=function(e){return n.clone(this.views[e])||[]},c._insertViews=function(e,t,i){console.log(">>> _insertViews:",e,t,i);var s=this,r=this.getViews(t);return n(e).each(function(e){e.parent&&e.parent.removeView(e,e.container)}),r.length?("undefined"==typeof i&&(i=r.length),a.apply(this.views[t],[i,0].concat(e))):this.views[t]=e,n(e).each(function(e){e.parent=s,e.container=t}),this.delegateNestedEvents("views",t,e),this},c._updateViews=function(e,t,i){console.log(">>> _updateViews:",e,t,i);var s=this.getViews(t);if(s.length){var r=[];"undefined"!=typeof i?(r=this.getView(t,i),r=r?[r]:[]):r=s,r.length&&(this._removeViews(r,t),n(r).each(function(e){e.remove()}))}return this._insertViews(e,t,i)},c._removeViews=function(e,t){console.log(">>> _removeViews:",e,t);var i=this,s=this.getViews(t);if(!s.length)return this;var r=n.chain(e).uniq().map(function(e){return{view:e,index:n.indexOf(s,e)}}).filter(function(e){return e.index>=0}).sortBy(function(e){return-e.index}).value();return r.length?(n(r).each(function(e){var n=e.view;a.call(i.views[t],e.index,1),i.undelegateNestedEvents(n),delete n.parent}),this):this},c.setElement=function(e){var t=this.$el;return this._setElement(e),t&&this.$container&&t.replaceWith(this.$el),this},c.delegateEvents=function(e){return(e=e||n.result(this,"events"))?(e=n(e).omit(o),s.View.prototype.delegateEvents.call(this,e)):this},c.delegateNestedEvents=function(e,t,i){var s=this;n.isArray(i)||(i=[i]);var r=this._nestedEventsHash[e][t];return r&&n(r).each(function(e){n(i).each(function(t){s.listenTo(t,e.eventName,e.handler)})}),this},c.undelegateNestedEvents=function(e){var t=this;return n.isArray(e)||(e=[e]),n(e).each(function(e){t.stopListening(e)}),this},c._prepareNestedEvents=function(e){var t=this;this._nestedEventsHash={},n(o).each(function(e){t._nestedEventsHash[e]={}}),e=e||n.result(this,"events"),e&&n(o).each(function(i){var s=t._nestedEventsHash[i];n(e).has(i)&&n.isObject(e[i])&&n(e[i]).each(function(e,i){if(n.isFunction(e)||(e=t[e]),e){var r=i.match(h),a=r[1],o=r[2].replace(/ *, */g,",").split(",");e=n.bind(e,t),n(o).each(function(t){s[t]=s[t]||[],s[t].push({eventName:a,handler:e})})}})})},c._normalizeViews=function(){var e=this;n(this.views).each(function(t,i){n.isArray(t)||(e.views[i]=[t])})},c.attachViews=function(){return n(this.views).each(function(e){e.length&&n(e).each(function(e){e.attachViews(),e.attach()})}),this},c.afterAttach=function(){return this},c.attach=function(){if(this.attached)return this;var e=this.$el.data("esencia-view");return e&&e.detach(),this.$el.data("esencia-view",this).attr("esencia-view",this.cid),this.delegateEvents(),this.attached=!0,console.log(">>>      attach: %o %o",this,this.$el),this.afterAttach(),this},c.detachViews=function(){return n(this.views).each(function(e){e.length&&n(e).each(function(e){e.detachViews(),e.detach()})}),this},c.beforeDetach=function(){return this},c.detach=function(){return this.attached?(console.log(">>>      detach: %o %o",this,this.$el),this.beforeDetach(),this.$el.removeData("esencia-view").removeAttr("esencia-view"),this.undelegateEvents(),this.attached=!1,this):this},c.remove=function(){return this.parent&&this.parent.removeView(this,this.container),this.detachViews(),this.detach(),s.View.prototype.remove.call(this)},c.getClosestView=function(e){var t=r(e);return t.is("[esencia-view]")||(t=t.closest("[esencia-view]")),t.length?t.data("esencia-view"):null},e.exports=s.View.extend(c)},function(e,i){e.exports=t},function(t,i){t.exports=e}],i(0)});
//# sourceMappingURL=view.min.js.map
