!function(e){"function"==typeof define&&define.amd?define(["underscore","backbone"],e):"object"==typeof exports?module.exports=e(require("underscore"),require("backbone")):this.Esencia.Router=e(_,Backbone)}(function(e,t){function n(e){var t=n.cache[e];if(!t){var i={};t=n.cache[e]={id:e,exports:i},n.modules[e].call(i,t,i)}return t.exports}return n.cache=[],n.modules=[function(e,t){"use strict";var i=n(3),s=n(2),r=n(1),o={root:"/",rootViewEl:"html",modulesPath:"modules/",defaultModuleName:"main",pushState:!1,namedParameters:!1,autoloadModules:!0,debug:!1,config:{},onModuleError:function(){},nowhereUrl:"___"},a=["root","rootViewEl","modulesPath","defaultModuleName","pushState","namedParameters","autoloadModules","debug","config","onModuleError","nowhereUrl"];o.constructor=function(e){e=e||{},i.extend(this,i.pick(e,a)),this.options=e,this.components={},this.componentsTree=null,this.urlParams={},this.modules={},this.history=s.history,s.Router.namedParameters=this.namedParameters,s.Router.apply(this,arguments),e.autoloadModules&&this.route("*url",function(e){this.setModule(e)})},o._initRootComponent=function(){var e=r.extend({el:this.rootViewEl});this.component({name:"",parent:null,View:e})},o._populateUrlParams=function(e,t){var n,s=this.urlParams;for(n in s)i(s).has(n)&&delete s[n];var r=this.components[e];return i(s).extend(i(r).result("defaultUrlParams"),t)};var h=["url","name","parent","container","View","models","collections","viewOptions","defaultUrlParams"];o.component=function(e){var t=this;e=i({}).defaults(e,{parent:"",defaultUrlParams:{},viewOptions:{},process:!1});var n=i(e).pick(h);if(i.isUndefined(n.name)&&(n.name=i.uniqueId("auto-named-component")),!i.isString(n.name))throw new Error("Component `name` option should be a string");if(n.name in this.components)throw new Error('Duplicate component with name "'+n.name+'"');if(!n.View)throw new Error("Component `View` option is required");if(!i.isString(n.parent)&&!i.isNull(n.parent))throw new Error("Component `parent` option should be a string or null");return this.components[n.name]=n,i.isUndefined(n.url)||this.route(n.url,n.name,function(e){t._populateUrlParams(n.name,e),t._processComponent(n.name)}),e.process&&this._processComponent(n.name),this},o._calculateComponentsTree=function(e,t){var n=this.components[e];if(!n)throw new Error('Unknown component with name "'+e+'"');var s={name:e};return t&&(s.child=t),i.isString(n.parent)?this._calculateComponentsTree(n.parent,s):s},o._isComponentTreeNodeChanged=function(e,t){if(!e||e.name!==t.name||!e.view)return!0;var n=this.components[t.name];return e.view instanceof n.View==!1||(!e.view.isAttached()||!e.view.isUnchanged())},o._applyComponentsTree=function(e,t){var n,s=this,r=e.parentNode,o=function(e,n){var i=n.child;delete n.child,r?r.child=n:s.componentsTree=n,i?s._applyComponentsTree({parentNode:n,oldNode:e&&e.child||null,node:i},t):t()},a=e.node,h=e.oldNode,c=this.components[a.name],u=function(e){if(a.view=e,e.setData(),c.container){if(!r)throw new Error("Parent component should exist for component with `container` option");r.view.setView(e,c.container),r.view.renderViews()}else e.render();o(null,a)};if(this._isComponentTreeNodeChanged(h,a))n=new c.View(i(c).chain().pick("models","collections").defaults(i(c).result("viewOptions")).extend({router:this}).value()),n.isWaiting()?n.once("resolve",function(){u(n)}):u(n);else{n=h.view;var l,d=h.child;d&&d.view&&(l=d.view.container,n.removeView(d.view,l)),a.view=n,n.setData(),n.render(),d&&d.view&&n.setView(d.view,l),o(h,a)}},o._processComponent=function(e,t){t=t||i.noop;var n=this._calculateComponentsTree(e);this._applyComponentsTree({parentNode:null,oldNode:this.componentsTree,node:n},t)},o.route=function(e,t,n){var r=this;i.isFunction(t)&&(n=t,t=""),s.Router.prototype.route.call(this,e,t,function(){var i=arguments;r._defaultMiddleware({url:e,name:t,callback:n},function(){n.apply(r,i)})})},o.navigate=function(e,t){if(t=t||{},0===e.indexOf(this.root)&&(e=e.substring(this.root.length)),t.force)return this.navigate(this.nowhereUrl,{replace:t.replace,trigger:!1}),t=i(t).chain().omit("force").extend({replace:!0}).value(),this.navigate(e,t);t=i(t||{}).defaults({trigger:!0,params:{}});var n=t.qs;n&&(i(n).each(function(e,t,n){void 0!==e&&null!==e||delete n[t]}),e=this.toFragment(e,n),delete t.qs),s.Router.prototype.navigate.call(this,e,t)},o._defaultMiddleware=function(e,t){t()},o.middleware=function(e){var t=this,n=this._defaultMiddleware;return this._defaultMiddleware=function(i,s){n.call(t,i,function(){e.call(t,i,s)})},this},o.setModule=function(e){var t=this,n=e.url;delete e.url;var s=i(n.split("/")).find(i.identity)||this.defaultModuleName;require([this.modulesPath+s],function(i){t.modules[s]||(i(t),t.modules[s]=!0,t.navigate(n,{replace:!0,force:!0,qs:e}))},this.onModuleError)},o.start=function(){this._initRootComponent(),s.history.start({pushState:this.pushState,root:this.root})},e.exports=s.Router.extend(o)},function(e,t){"use strict";var i=n(3),s=n(2),r=s.$,o=Array.prototype.splice,a=/^(\S+)\s*(.*)$/,h=["views","collections","models"],c={templateHelpers:{}},u=["models","collections","views","events","data","router","templateHelpers"];c.wait=function(){var e=this;return this._waiting=!0,function(){e._waiting=!1,e.trigger("resolve")}},c.isWaiting=function(){return this._waiting},c.constructor=function(e){var t=this;if(e=e||{},this.views={},this.data=this.data||{},i.extend(this,i.pick(e,u)),this.options=e,this.template&&!i.isFunction(this.template))throw new Error("View `template` option should be a function");this._normalizeViews(),this._prepareNestedEvents(),this._waiting=!1,s.View.apply(this,arguments),this.collections&&i(this.collections).each(function(e,n){t.delegateNestedEvents("collections",n,e)}),this.models&&i(this.models).each(function(e,n){t.delegateNestedEvents("models",n,e)})},c.setData=function(e){e&&(this.data=e)},c.isUnchanged=function(){return!0},c.render=function(e){return this.isWaiting()?this:(e=e||{},!this.template||!e.force&&this.isAttached()&&this.isUnchanged()||(this._createTemplateElement(),this._isAfterAttachNeeded=!0),this.attach(),this.renderViews(e),this.$el.parent().length&&this._afterAttachViews(),this)},c.getTemplateData=function(){return this.data},c.renderTemplate=function(e,t){return t=i(this).chain().result("templateHelpers").extend(t).value(),e(t)},c._createTemplateElement=function(){var e=this.getTemplateData(),t=this.renderTemplate(this.template,e),n=r(t);n.length>1;var i=n.first();return this.$el.parent().length&&this.$el.replaceWith(i),this.setElement(i,!0),this},c.renderViews=function(e){var t=this;i(this.views).each(function(n,s){if(n.length){i(n).each(function(t){t.render(e)});var r=s?t.$(s).first():t.$el;if(!r.length)throw new Error('Container "'+s+'" is not found');i(n).some(function(e){return!e.isAttached()||!r.is(e.$el.parent())})&&r.append(i(n).pluck("$el"))}})},c.setView=c.setViews=function(e,t,n){return this._updateViews("set",e,t,n)},c.replaceView=c.replaceViews=function(e,t,n){return this.setViews.apply(this,arguments)},c.appendView=c.appendViews=function(e,t){return this.insertViews(e,t)},c.prependView=c.prependViews=function(e,t){return this.insertViews(e,t,0)},c.insertView=c.insertViews=function(e,t,n){return this._updateViews("insert",e,t,n)},c.removeView=c.removeViews=function(e,t,n){if(arguments.length<2)throw new Error('"views" or "index" arguments must be specified');return i.isString(e)&&(n=t,t=e,e=this.getView(t,n),!e)?this:this._updateViews("remove",e,t)},c.getView=function(e,t){return this.getViews(e)[t||0]||null},c.getViews=function(e){return i.clone(this.views[e])||[]},c._updateViews=function(e,t,n,s){var r=this;if(!t)throw new Error('"views" argument must be specified');i.isArray(t)||(t=[t]);var a=this.getViews(n);switch(e){case"set":if(a.length){var h=[];"undefined"!=typeof s?(h=this.getView(n,s),h=h?[h]:[]):h=a,h.length&&(this._updateViews("remove",h,n),i(h).each(function(e){e.remove()}))}this._updateViews("insert",t,n,s);break;case"insert":i(t).each(function(e){e.parent&&e.parent.removeView(e,e.container)}),a.length?("undefined"==typeof s&&(s=a.length),o.apply(this.views[n],[s,0].concat(t))):this.views[n]=t,i(t).each(function(e){e.parent=r,e.container=n}),this.delegateNestedEvents("views",n,t);break;case"remove":if(!a.length)break;var c=i.chain(t).uniq().map(function(e){return{view:e,index:i.indexOf(a,e)}}).filter(function(e){return e.index>=0}).sortBy(function(e){return-e.index}).value();if(!c.length)break;i(c).each(function(e){var t=e.view;o.call(r.views[n],e.index,1),r.undelegateNestedEvents(t),delete t.parent})}return this},c.delegateEvents=function(e){return(e=e||i.result(this,"events"))?(e=i(e).omit(h),s.View.prototype.delegateEvents.call(this,e)):this},c.delegateNestedEvents=function(e,t,n){var s=this;i.isArray(n)||(n=[n]);var r=this._nestedEventsHash[e][t];return r&&i(r).each(function(e){i(n).each(function(t){s.listenTo(t,e.eventName,e.handler)})}),this},c.undelegateNestedEvents=function(e){var t=this;return i.isArray(e)||(e=[e]),i(e).each(function(e){t.stopListening(e)}),this},c._prepareNestedEvents=function(e){var t=this;this._nestedEventsHash={},i(h).each(function(e){t._nestedEventsHash[e]={}}),e=e||i.result(this,"events"),e&&i(h).each(function(n){var s=t._nestedEventsHash[n];i(e).has(n)&&i.isObject(e[n])&&i(e[n]).each(function(e,n){if(i.isFunction(e)||(e=t[e]),e){var r=n.match(a),o=r[1],h=r[2].replace(/ *, */g,",").split(",");e=i.bind(e,t),i(h).each(function(t){s[t]=s[t]||[],s[t].push({eventName:o,handler:e})})}})})},c._normalizeViews=function(){var e=this;i(this.views).each(function(t,n){i.isArray(t)||(e.views[n]=[t])})},c.isAttached=function(){var e=this.$el.data("esencia-view");return Boolean(e&&e===this)},c._afterAttachViews=function(){i(this.views).each(function(e){e.length&&i(e).each(function(e){e._afterAttachViews()})}),this._isAfterAttachNeeded&&(delete this._isAfterAttachNeeded,this.afterAttach())},c.afterAttach=function(){return this},c.attach=function(){if(this.isAttached())return this;var e=this.$el.data("esencia-view");return e&&e.detach(),this.$el.data("esencia-view",this).attr("esencia-view",this.cid),this},c._detachViews=function(){i(this.views).each(function(e){e.length&&i(e).each(function(e){e.detach()})})},c.beforeDetach=function(){return this},c.detach=function(){return this.isAttached()?(this._detachViews(),this.beforeDetach(),this.$el.removeData("esencia-view").removeAttr("esencia-view"),this.undelegateEvents(),this.stopListening(),this):this},c.remove=function(){return this.parent&&this.parent.removeView(this,this.container),this.detach(),this._removeElement(),this},c.getClosestView=function(e){var t=r(e);return t.is("[esencia-view]")||(t=t.closest("[esencia-view]")),t.length?t.data("esencia-view"):null},e.exports=s.View.extend(c)},function(e,n){e.exports=t},function(t,n){t.exports=e}],n(0)});
//# sourceMappingURL=router.min.js.map
